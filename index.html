<!DOCTYPE html>
<html lang="bi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Baebol Kwestin</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="BibleQ192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="BibleQ192.png">
    <meta name="theme-color" content="#1a5276">
    <style>
        :root{
            --bg:#f8fbff;--card:#ffffff;--text:#2c3e50;--primary:#1a5276;--accent:#3498db;
            --success:#27ae60;--warning:#e67e22;--danger:#e74c3c;--border:#d6eaf8;--shadow:rgba(0,0,0,0.1);
        }
        .dark-mode{
            --bg:#1a1a1a;--card:#2d2d2d;--text:#f0f0f0;--primary:#64B5F6;--accent:#4FC3F7;
            --success:#66BB6A;--warning:#FF8A65;--danger:#EF5350;--border:#444;--shadow:rgba(0,0,0,0.3);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%;font-family:Georgia,serif;background:var(--bg);color:var(--text)}
        body{display:flex;flex-direction:column;max-width:800px;margin:0 auto;padding:12px;font-size:17px;line-height:1.7}
        .header{position:relative;text-align:center;padding:16px 56px 8px}
        .header h1{color:var(--primary);font-family:Arial,sans-serif;font-size:1.8em;line-height:.5;margin:0}
        .fab{position:absolute;top:16px;width:48px;height:48px;border-radius:50%;background:var(--card);
            border:1px solid var(--border);box-shadow:0 3px 8px var(--shadow);display:flex;align-items:center;
            justify-content:center;cursor:pointer;transition:transform .2s,box-shadow .2s;z-index:10}
        .fab:hover{transform:scale(1.1);box-shadow:0 5px 12px var(--shadow)}
        .fab svg{width:28px;height:28px;fill:var(--primary)}
        #shareFab{left:8px}#darkFab{right:8px}
        .subtitle{text-align:center;font-style:italic;color:#5d6d7e;margin:2px 0 16px;font-size:1em}
        .card-wrapper{flex:1;display:flex;flex-direction:column;gap:16px;padding:8px 0}
        .card{background:var(--card);padding:20px;border-radius:16px;box-shadow:0 6px 20px var(--shadow);border:1px solid var(--border)}
        label{display:block;font-weight:bold;color:var(--primary);margin-bottom:8px;font-size:1.1em}
        .input-wrapper{position:relative}
        textarea{width:100%;padding:12px 36px 12px 12px;border:1px solid #aed6f1;border-radius:10px;
            font-size:16px;min-height:90px;resize:vertical;font-family:inherit}
        .clear-circle{position:absolute;background:var(--danger);color:white;border:none;width:20px;height:20px;
            border-radius:50%;font-size:13px;font-weight:bold;cursor:pointer;display:flex;align-items:center;
            justify-content:center;padding:0;line-height:1}
        #clearBtn{top:6px;right:6px;display:none}#closeHistoryBtn{top:8px;right:8px}
        .btn-row{display:flex;gap:10px;margin-top:8px}
        button{flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:bold;
            cursor:pointer;transition:.2s;box-shadow:0 3px 6px var(--shadow)}
        #askBtn{background:#2980b9;color:white}#askBtn:hover{background:#1a5276}
        #randomBtn{background:#9b59b6;color:white}#randomBtn:hover{background:#8e44ad}
        #randomQuestions{margin-top:12px;display:none;text-align:center}
        .random-q-btn{display:block;width:100%;margin:8px 0;background:var(--accent);color:white;
            padding:14px;border-radius:12px;font-size:15px;text-align:left;cursor:pointer;
            box-shadow:0 3px 8px var(--shadow);transition:.2s;font-weight:500}
        .random-q-btn:hover{background:#2980b9;transform:translateY(-2px);box-shadow:0 5px 12px var(--shadow)}
        #answer{background:var(--card);padding:18px;border-radius:12px;border-left:5px solid var(--accent);
            max-height:60vh;overflow-y:auto;display:none}
        #answerHeader{display:none;justify-content:flex-end;margin-bottom:8px}
        #explainMoreBtn{background:var(--accent);color:white;padding:6px 12px;border-radius:6px;font-size:13px;font-weight:normal}
        #answerContent{line-height:1.8}
        #welcomeVerse{text-align:center;background:var(--card);padding:18px;border-radius:12px;display:none}
        #historyModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);
            z-index:100;justify-content:center;align-items:center}
        #historyModal>div{background:var(--card);padding:20px;border-radius:16px;max-width:90%;max-height:80%;
            overflow-y:auto;box-shadow:0 10px 30px var(--shadow);position:relative}
        .footer{text-align:center;color:#95a5a6;font-size:.85em;padding:12px 0;background:var(--card);
            border-top:1px solid var(--border);flex-shrink:0}
        .error{background:#fdf2f2;border:1px solid var(--danger);color:#c0392b;padding:14px;border-radius:8px;
            text-align:center;font-weight:bold}
        @keyframes flash{0%,100%{background:#D30000}50%{background:#FF3333}}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="header">
        <button id="shareFab" class="fab" title="Share">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
        </button>
        <h1>Baebol Kwestin</h1>
        <button id="darkFab" class="fab" title="Dark Mode">
            <svg id="moonIcon" viewBox="0 0 24 24" style="display:block;"><path d="M12 1c-6.07 0-11 5.43-11 11s4.93 11 11 11 11-4.93 11-11-4.93-11-11-11zm-0 18c-4.14 0-7.5-3.36-7.5-7.5 0-2.6 1.32-4.88 3.33-6.23.61-.41 1.39.25.94.94-.68 1.05-1.07 2.29-1.07 3.62 0 3.59 2.91 6.5 6.5 6.5 1.33 0 2.57-.39 3.62-1.07.69-.45 1.35.33.94.94-1.35 2.01-3.63 3.33-6.76 3.33z"/></svg>
            <svg id="sunIcon" viewBox="0 0 24 24" style="display:none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1H2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zm18 0h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zm-9-9h2c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zm0 18h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zM6.35 6.35l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L7.76 4.94c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41zm12.73 12.73l1.41 1.41c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41zM17.66 6.34c-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41c-.39-.39.39-1.02 0-1.41zM6.34 17.66c-.39-.39-1.02-.39-1.41 0l-1.41 1.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l1.41-1.41c-.39-.39.39-1.02 0-1.41z"/></svg>
        </button>
    </div>
    <p class="subtitle">Askem eni kwestin long Baebol</p>
    <div class="card-wrapper">
        <div class="card">
            <form id="queryForm">
                <label for="question">Raetem kwestin blong yu:</label>
                <div class="input-wrapper">
                    <textarea id="question" placeholder="e.g., From wanem Jisas i mas ded long kros?" rows="3"></textarea>
                    <button type="button" id="clearBtn" class="clear-circle">x</button>
                </div>
                <div class="btn-row">
                    <button type="submit" id="askBtn">Askem Baebol</button>
                    <button type="button" id="randomBtn">Givim Kwestin</button>
                </div>
                <div id="historyBtn" style="margin-top:12px;text-align:center;display:none;">
                    <button type="button" id="showHistoryBtn" style="background:#27ae60;color:white;padding:8px 16px;border-radius:8px;font-weight:bold;">Ol kwestin we yu askem finis (0)</button>
                </div>
                <div id="randomQuestions"></div>
            </form>
        </div>
        <div id="answer">
            <div id="answerHeader">
                <button type="button" id="explainMoreBtn">Mekem ansa i longfala lelebet...</button>
            </div>
            <div id="answerContent"></div>
        </div>
        <div id="welcomeVerse"></div>
    </div>
    <div id="historyModal">
        <div>
            <button type="button" id="closeHistoryBtn" class="clear-circle">x</button>
            <h3 style="margin:0 0 12px 0;color:var(--primary);text-align:center;">Ol kwestin we yu askem finis</h3>
            <div id="historyList"></div>
        </div>
    </div>
    <footer class="footer">
        Mi, Ross Webb, mi mekem app ia (2.0). Mi prea se bae God i yusum app ia blo givhan long Kristim laef blong yu.
    </footer>

    <script>
        // === INSTALL PROMPT ===
        let deferredPrompt=null,installBtn=null;
        window.addEventListener('beforeinstallprompt',e=>{
            e.preventDefault();deferredPrompt=e;
            if(installBtn)installBtn.remove();
            installBtn=document.createElement('button');
            installBtn.textContent='Instolem Baebol Kwestin app ia';
            installBtn.style.cssText=`
                position:fixed;bottom:30%;left:50%;transform:translateX(-50%);
                background:#D30000;color:white;padding:16px 20px;border:none;
                border-radius:16px;font-weight:bold;font-size:18px;z-index:1000;
                animation:flash .8s infinite;box-shadow:0 4px 12px rgba(0,0,0,.3);
                min-width:240px;text-align:center`;
            installBtn.onclick=()=>{installBtn.remove();deferredPrompt.prompt();deferredPrompt=null;};
            document.body.appendChild(installBtn);
        });

        // === KEYS ===
        const GEMINI_KEY = atob("QUl6YVN5RDZXbzB1cHFmd0NiaUEwRTZpQ0tIclJ2Mm5EYTZfSTVN");
        const OR_KEY = atob("c2stb3ItdjEtMDRkYTAwZjc5YzIzZTQ2MTgzMDcxYzRhNDYwMmVmZWY0ZmMxOTdiZWEwZTdkMTIwZTVkNWE2OWQwNjNhNGQwYQ==");
        marked.setOptions({gfm:true,breaks:false,sanitize:false,headerIds:false});

        const form=document.getElementById('queryForm'),
              questionInput=document.getElementById('question'),
              askBtn=document.getElementById('askBtn'),
              randomBtn=document.getElementById('randomBtn'),
              answerDiv=document.getElementById('answer'),
              answerHeader=document.getElementById('answerHeader'),
              answerContent=document.getElementById('answerContent'),
              explainMoreBtn=document.getElementById('explainMoreBtn'),
              randomDiv=document.getElementById('randomQuestions'),
              clearBtn=document.getElementById('clearBtn'),
              showHistoryBtn=document.getElementById('showHistoryBtn'),
              historyModal=document.getElementById('historyModal'),
              historyList=document.getElementById('historyList'),
              closeHistoryBtn=document.getElementById('closeHistoryBtn'),
              welcomeVerse=document.getElementById('welcomeVerse'),
              shareFab=document.getElementById('shareFab'),
              darkFab=document.getElementById('darkFab'),
              sunIcon=document.getElementById('sunIcon'),
              moonIcon=document.getElementById('moonIcon');

        let currentQuestion = '';
        let isAutoSubmit = false;

        // === SYSTEM PROMPT ===
        const systemPrompt = `You are a kind Bible teacher in Vanuatu.
Answer in SIMPLE, ACTIVE English that a 13-year-old can read and understand.
Answers follow REFORMED theology. Do NOT contradict these truths (they need not appear in every answer):
- God created everything and is sovereign.
- Every person sins and needs forgiveness.
- Jesus, God’s Son, died on the cross to pay for sin.
- He rose again to give new life.
- Salvation is by faith in Jesus alone, not works.
- The Holy Spirit helps us obey and love others.
- The Bible is God’s true Word.
- Jesus will return to judge; believers go to heaven, unbelievers to hell (as the Bible teaches).
**FORMAT EXACTLY LIKE THIS:**
Do *NOT* start with an introductory greeting
## Main Idea
### Step 1: Do This
- bullet points
- keep short
### Step 2: Remember This
**John 3:16** *"For God loved the world so much that he gave his only Son, so that everyone who believes in him may not die but have eternal life."*
**Romans 5:8** *"But God has shown us how much he loves us—it was while we were still sinners that Christ died for us!"*
**Ephesians 2:8-9** *"For it is by God's grace that you have been saved through faith. It is not the result of your own efforts, but God's gift, so that no one can boast about it."*
End with one short sentence of hope or encouragement.
Keep under 350 words. Cite 3+ verses from the TEV Bible. Be warm, clear, and kind.`;

        // === AI CALLS (FIXED TYPO: Pursuant → max_tokens) ===
        async function tryOpenRouter(q){
            const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OR_KEY}`
                },
                body: JSON.stringify({
                    model: "mistralai/devstral-small-2505:free",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: q }
                    ],
                    max_tokens: 4000,
                    temperature: 0.7
                })
            });
            return { response: res, source: 'OpenRouter' };
        }
        async function tryGemini(q){
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: systemPrompt + "\n\nQuestion: " + q }] }],
                    generationConfig: { maxOutputTokens: 8192, temperature: 0.7 },
                    safetySettings: [
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }
                    ]
                })
            });
            return { response: res, source: 'Gemini' };
        }

        async function getAnswer(q, isExplainMore = false) {
            const fullQ = isExplainMore
                ? q + "\n\nGive a FULL, DETAILED answer suitable for Bible study. Up to 1200 words. Cite 5+ verses from TEV version of the Bible."
                : q;

            // Try Gemini
            try {
                const gemini = await tryGemini(fullQ);
                if (gemini.response.ok) {
                    const data = await gemini.response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) return { text, source: 'Gemini' };
                } else {
                    console.warn("Gemini failed:", gemini.response.status);
                }
            } catch (e) { console.warn("Gemini error:", e); }

            // Try OpenRouter
            try {
                const or = await tryOpenRouter(fullQ);
                if (or.response.ok) {
                    const data = await or.response.json();
                    const text = data.choices?.[0]?.message?.content;
                    if (text) return { text, source: 'OpenRouter' };
                } else {
                    console.warn("OpenRouter failed:", or.response.status);
                }
            } catch (e) { console.warn("OpenRouter error:", e); }

            // BOTH FAILED
            return { text: "Sore, mi no karem ansa. Gemini mo OpenRouter i nogat. Trae bakegen lelebet.", source: 'none' };
        }

        // === HANDLE SUBMIT ===
        const handleSubmit = async (q) => {
            if (!q) return;
            currentQuestion = q;
            askBtn.disabled = true; askBtn.textContent = 'Wet long ansa...';
            answerDiv.style.display = 'none'; answerHeader.style.display = 'none';
            answerContent.innerHTML = ''; welcomeVerse.style.display = 'none';

            const result = await getAnswer(q);
            if (result.source !== 'none') {
                answerContent.innerHTML = marked.parse(result.text);
                answerHeader.style.display = 'flex';
                answerDiv.style.display = 'block';
                saveAnswer(q, answerContent.innerHTML);
            } else {
                answerContent.innerHTML = `<div class="error">${result.text}</div>`;
                answerDiv.style.display = 'block';
                showWelcome();
            }

            askBtn.disabled = false; askBtn.textContent = 'Askem Baebol';
            isAutoSubmit = false;
        };

        // === FORM SUBMIT ===
        form.addEventListener('submit', e => {
            e.preventDefault();
            if (isAutoSubmit) return;
            const q = questionInput.value.trim();
            if (!q) return;
            handleSubmit(q);
        });

        // === SEEDS ===
        const ANIMISM_SEED = [ /* ... 20 items ... */ ];
        const GENERAL_SEED = [ /* ... 10 items ... */ ];

        // === SHOW BUTTONS (NOW CALLS handleSubmit) ===
        const showQuestionButtons = qs => {
            randomDiv.innerHTML = '';
            qs.forEach(q => {
                const b = document.createElement('button');
                b.className = 'random-q-btn';
                b.textContent = q;
                b.onclick = () => {
                    questionInput.value = q;
                    questionInput.dispatchEvent(new Event('input'));
                    randomDiv.style.display = 'none';
                    isAutoSubmit = true;
                    handleSubmit(q);  // FIXED: NOW CALLS AI
                };
                randomDiv.appendChild(b);
            });
            randomDiv.style.display = 'block';
        };

        // === GIVIM KWESTIN — AUTO-REFILL FOREVER ===
        randomBtn.addEventListener('click', e => {
            e.preventDefault();

            let c = { general: [], animism: [], used: [] };
            try {
                const raw = localStorage.getItem('randomQCache');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (parsed && typeof parsed === 'object') {
                        c.general = Array.isArray(parsed.general) ? parsed.general : [];
                        c.animism = Array.isArray(parsed.animism) ? parsed.animism : [];
                        c.used = Array.isArray(parsed.used) ? parsed.used : [];
                    }
                }
            } catch (err) {}

            // AUTO-REFILL IF BOTH EMPTY
            if (c.general.length === 0 && c.animism.length === 0) {
                c.animism = [...ANIMISM_SEED];
                c.general = [...GENERAL_SEED];
                c.used = [];
            }

            const five = [];
            let used = c.used || [];

            if (c.animism.length > 0) {
                const i = Math.floor(Math.random() * c.animism.length);
                const q = c.animism.splice(i, 1)[0];
                five.push(q);
                used = used.filter(x => x !== q);
            }

            while (five.length < 5 && c.general.length > 0) {
                const i = Math.floor(Math.random() * c.general.length);
                const q = c.general[i];
                if (used.includes(q)) {
                    c.general.splice(i, 1);
                    continue;
                }
                c.general.splice(i, 1);
                five.push(q);
                used = used.filter(x => x !== q);
            }

            // IF STILL <5 → REFILL AND CONTINUE
            if (five.length < 5) {
                c.animism = [...ANIMISM_SEED];
                c.general = [...GENERAL_SEED];
                c.used = [];
                // Try again
                while (five.length < 5 && (c.animism.length > 0 || c.general.length > 0)) {
                    const pool = c.animism.length > 0 ? c.animism : c.general;
                    const i = Math.floor(Math.random() * pool.length);
                    const q = pool.splice(i, 1)[0];
                    if (!five.includes(q)) five.push(q);
                }
            }

            c.used = [...five, ...used].slice(0, 10);
            try { localStorage.setItem('randomQCache', JSON.stringify(c)); } catch(e) {}

            showQuestionButtons(five);
        });

        // === REST OF CODE (unchanged) ===
        // ... explainMoreBtn, clearBtn, history, share, dark mode, init ...
    </script>
</body>
</html>
