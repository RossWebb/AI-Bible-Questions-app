<!DOCTYPE html>
<html lang="en">
   <head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta name="google" content="notranslate">
   <title>Baebol Kwestin</title>
      <link rel="manifest" href="./manifest.json">
      <link rel="icon" href="BibleQ192.png" type="image/png">
      <meta name="theme-color" content="#1a5276">
	  <meta name="mobile-web-app-capable" content="yes"
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="default">
      <meta name="apple-mobile-web-app-title" content="Baebol">
      <style>
         :root{--bg:#f8fbff;--card:#fff;--text:#2c3e50;--primary:#1a5276;--accent:#3498db;--border:#d6eaf8;--shadow:rgba(0,0,0,0.1);--danger:#e74c3c}
		  html {
			  height: 100%;
			  overflow-y: auto;
		  }
         .dark-mode{--bg:#1a1a1a;--card:#2d2d2d;--text:#f0f0f0;--primary:#64B5F6;--accent:#4FC3F7;--border:#444;--shadow:rgba(0,0,0,0.3)}
         *{box-sizing:border-box;margin:0;padding:0}
         body{font-family:Georgia,serif;background:var(--bg);color:var(--text);padding:12px;max-width:800px;margin:auto;display:flex;flex-direction:column;min-height:100vh}
		 .header{position:relative;text-align:center;padding:16px 56px 4px}
         h1{color:var(--primary);font-size:1.8em;margin:0;line-height:1.2}
         .fab{
         position:absolute;top:16px;width:48px;height:48px;border-radius:50%;
         background:var(--card);border:1px solid var(--border);box-shadow:0 3px 8px var(--shadow);
         display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;
         }
         .fab svg{width:28px;height:28px;fill:var(--primary)}
		 #langFab{left:8px}#darkFab{right:8px}
         .subtitle{text-align:center;font-style:italic;color:#5d6d7e;margin:2px 0 16px;font-size:1em}
         .card{background:var(--card);padding:20px;border-radius:16px;box-shadow:0 6px 20px var(--shadow);border:1px solid var(--border);margin-bottom:16px}
         label{display:block;font-weight:bold;color:var(--primary);margin-bottom:8px}
         .input-wrapper{position:relative}
         textarea{width:100%;padding:12px 36px 12px 12px;border:1px solid #aed6f1;border-radius:10px;font-size:16px;min-height:90px;resize:vertical;font-family:Georgia,serif}
         .clear-circle{
         position:absolute;top:6px;right:6px;background:var(--danger);color:white;border:none;
         width:20px;height:20px;border-radius:50%;font-size:13px;font-weight:bold;cursor:pointer;
         display:none;align-items:center;justify-content:center;line-height:1;
         }
         .btn-row{display:flex;gap:5px;margin-top:8px}
         button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
         .button-loading {
         animation: flashButton 1s infinite;
         pointer-events: none;
         }
         #askBtn{background:#2980b9;color:white}#randomBtn{background:#9b59b6;color:white}
         #randomQuestions{margin-top:12px;display:none}
         .random-q-btn{
         display:block;width:100%;margin:8px 0;background:var(--accent);color:white;
         padding:14px;border-radius:12px;cursor:pointer;font-weight:500;text-align:center;
         font-size:15px;line-height:1.4;
         }
         .random-q-btn:hover{background:#2980b9}
         #answer{background:var(--card);padding:18px;border-radius:12px;border-left:5px solid var(--accent);display:none;max-height:60vh;overflow-y:auto}
		 #explainMoreBtn{background:var(--accent);color:white;padding:6px 12px;border-radius:6px;font-size:13px;white-space:nowrap}
         #answerContent{line-height:1.8;font-size:15px}
         #answerContent ul, #answerContent ol { padding-left: 1.5em; margin: 0.5em 0; }
         #answerContent li { margin-bottom: 0.3em; }
         #answerContent h2 {
         color: var(--primary);
         font-size: 1.3em;
         margin-top: 1.2em;
         margin-bottom: 0.6em;
         padding-bottom: 0.3em;
         border-bottom: 2px solid var(--accent);
         }
         #answerContent h3 {
         color: var(--accent);
         font-size: 1.1em;
         margin-top: 1em;
         margin-bottom: 0.5em;
         }
         #answerContent strong {
         color: var(--primary);
         }
         #answerContent em {
         color: var(--text);
         font-style: italic;
         }
         #answerContent p {
         margin-bottom: 0.8em;
         }		
         #welcomeVerse{text-align:center;background:var(--card);padding:40px;border-radius:12px;display:block}
         
		 #welcomeVerse strong{display:block;color:var(--primary);margin-bottom:.4rem}
         
		 #welcomeVerse em{margin:0 0 1.2rem;padding-left:0;position:relative;text-align:center}
         
		 #welcomeVerse em::before{content:'"';color:var(--accent)}
         
		 #welcomeVerse em::after{content:'"';color:var(--accent)}
         
		 #historyBtn{margin-top:12px;text-align:center;display:none}
         
		 #historyBtn button{background:#27ae60;color:white;padding:8px 16px;border-radius:8px;font-weight:bold}
         #historyModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center}
         
		 #historyModal > div{
         background:var(--card);padding:20px;border-radius:16px;
         width:90%;max-width:700px;max-height:80%;
         overflow-y:auto;box-shadow:0 10px 30px var(--shadow);position:relative;
         }
        
		#closeHistoryBtn{          position:absolute;top:8px;right:8px;;color:silver;border:none;;
         width:32px;height:32px;border-radius:50%;font-size:16px;cursor:pointer;
         display:flex;align-items:center;justify-content:center;z-index:999;
         }
         .history-item {
         border-bottom: 1px solid var(--border);
         padding: 12px 0;
         }
         .history-question {
         cursor: pointer;
         padding: 8px;
         border-radius: 8px;
         transition: background 0.2s;
         }
         .history-question:hover {
         background: var(--border);
         }
         .history-answer {
         display: none;
         margin-top: 8px;
         padding: 12px;
         background: var(--bg);
         border-radius: 8px;
         font-size: 14px;
         line-height: 1.6;
         }
         .history-answer h2 {
         color: var(--primary);
         font-size: 1.2em;
         margin-top: 1em;
         margin-bottom: 0.5em;
         padding-bottom: 0.3em;
         border-bottom: 2px solid var(--accent);
         }
         .history-answer h3 {
         color: var(--accent);
         font-size: 1em;
         margin-top: 0.8em;
         margin-bottom: 0.4em;
         }
         .history-answer strong {
         color: var(--primary);
         }
         .history-answer em {
         color: var(--text);
         font-style: italic;
         }
         .history-answer p {
         margin-bottom: 0.6em;
         }
         .history-answer.expanded {
         display: block;
         }
         .history-open-btn {
         background: #e67e22;
         color: white;
         border: none;
         padding: 6px 12px;
         border-radius: 6px;
         font-size: 13px;
         font-weight: bold;
         cursor: pointer;
         margin-top: 8px;
         }
         .history-open-btn:hover {
         background: #d35400;
         }

         #errorMessage {
         display: none;
         background: #e74c3c;
         color: white;
         padding: 12px;
         border-radius: 8px;
         text-align: center;
         font-weight: bold;
         margin-bottom: 12px;
         animation: flash 1.5s infinite;
         position: fixed;
         top: 20px;
         left: 50%;
         transform: translateX(-50%);
         z-index: 10000;
         max-width: 90%;
         box-shadow: 0 4px 12px rgba(0,0,0,0.3);
         }

         #customAlert {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0,0,0,0.6);
         z-index: 10001;
         justify-content: center;
         align-items: center;
         }

         #customAlert > div {
         background: var(--card);
         padding: 24px;
         border-radius: 16px;
         max-width: 400px;
         width: 90%;
         box-shadow: 0 10px 40px rgba(0,0,0,0.3);
         text-align: center;
         }
         #customAlert .alert-icon {
         font-size: 48px;
         margin-bottom: 16px;
         }
 
        #customAlert .alert-message {
         color: var(--text);
         font-size: 16px;
         line-height: 1.6;
         margin-bottom: 20px;
         }
         
		 #customAlert button {
         background: var(--primary);
         color: white;
         padding: 12px 32px;
         border: none;
         border-radius: 10px;
         font-weight: bold;
         font-size: 16px;
         cursor: pointer;
         min-width: 120px;
         }
         
		 #customAlert button:hover {
         background: var(--accent);
         }
		 
		 #customConfirm {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.6);
			z-index: 10002;
			justify-content: center;
			align-items: center;
		}
		#customConfirm > div {
			background: var(--card);
			padding: 24px;
			border-radius: 16px;
			max-width: 400px;
			width: 90%;
			box-shadow: 0 10px 40px rgba(0,0,0,0.3);
			text-align: center;
		}
		#customConfirm .confirm-icon {
			font-size: 48px;
			margin-bottom: 16px;
			color: var(--danger);
		}
		#customConfirm .confirm-message {
			color: var(--text);
			font-size: 16px;
			line-height: 1.6;
			margin-bottom: 20px;
		}
		#customConfirm .confirm-buttons {
			display: flex;
			gap: 12px;
		}
		#customConfirm button {
			flex: 1;
			padding: 12px 24px;
			border: none;
			border-radius: 10px;
			font-weight: bold;
			font-size: 16px;
			cursor: pointer;
		}
		#customConfirm .confirm-yes {
			background: var(--danger);
			color: white;
		}
		#customConfirm .confirm-yes:hover {
			background: #c0392b;
		}
		#customConfirm .confirm-no {
			background: var(--border);
			color: var(--text);
		}
		#customConfirm .confirm-no:hover {
			background: #bdc3c7;
		}
		#langModal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.6);
			z-index: 10003;
			justify-content: center;
			align-items: center;
		}
		#langModal > div {
			background: var(--card);
			padding: 24px;
			border-radius: 16px;
			max-width: 300px;
			width: 90%;
			box-shadow: 0 10px 40px rgba(0,0,0,0.3);
		}
		#langModal h3 {
			color: var(--primary);
			margin-bottom: 20px;
			text-align: center;
		}
		.lang-option {
			background: var(--bg);
			padding: 16px;
			margin: 10px 0;
			border-radius: 10px;
			cursor: pointer;
			text-align: center;
			font-weight: bold;
			border: 2px solid var(--border);
			transition: all 0.2s;
		}
		.lang-option:hover {
			background: var(--accent);
			color: white;
			border-color: var(--accent);
		}
		.lang-option.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}		
		.footer {
		  margin-top: auto;
		  display: flex;
		  align-items: center;      /* vertical centring */
		  justify-content: center;  /* horizontal centring */
		  text-align: center;
		  color: #95a5a6;
		  font-size: .85em;
		  padding: 10px;            /* 2px smaller than 12px */
		  background: var(--card);
		  border-top: 1px solid var(--border);
}

         #debug{font-size:12px;color:#7f8c8d;text-align:right;margin-top:4px}
         /* PWA Install Button */
         #installBtn, #iosInstall {
         position: fixed;
         bottom: 40px;
         left: 50%;
         transform: translateX(-50%);
         padding: 16px 24px;
         border-radius: 12px;
         font-weight: bold;
         font-size: 1.1em;
         z-index: 1000;
         box-shadow: 0 4px 12px rgba(0,0,0,.3);
         border: none;
         cursor: pointer;
         text-align: center;
         max-width: 90%;
         }
         #installBtn {
         background: #e74c3c;
         color: white;
         animation: flash 1.5s infinite;
         }
         #iosInstall {
         background: #1a5276;
         color: white;
         }
         @keyframes flash {
         0%, 100% { background: #e74c3c; }
         50% { background: #c0392b; }
         }
         @keyframes flashButton {
         0%, 100% { background: #e74c3c; }
         50% { background: #c0392b; }
         }		
      </style>
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   </head>
   <body>
      <div class="header">
	   	 <button id="langFab" class="fab">
			 <svg viewBox="0 0 640 640" style="width:24px;height:24px;fill:var(--primary)">
				 <path d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3 0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1 .1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2L179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4c.9 .6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9l-18.9-11.3c-4.5-2.7-8.8-5.5-13.1-8.5c-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8l-12.2-12.2c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6 .5 .5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/>
			 </svg>
		 </button>		 		 
         <button id="darkFab" class="fab">
            <svg id="moon" viewBox="0 0 23 23">
               <path d="M12 1c-6.07 0-11 5.43-11 11s4.93 11 11 11 11-4.93 11-11-4.93-11-11-11zm-0 18c-4.14 0-7.5-3.36-7.5-7.5 0-2.6 1.32-4.88 3.33-6.23.61-.41 1.39.25.94.94-.68 1.05-1.07 2.29-1.07 3.62 0 3.59 2.91 6.5 6.5 6.5 1.33 0 2.57-.39 3.62-1.07.69-.45 1.35.33.94.94-1.35 2.01-3.63 3.33-6.76 3.33z"/>
            </svg>
            <svg id="sun" viewBox="0 0 600 600" style="display:none">
               <path d="M232.6 56.1C225.9 51.7 217.5 50.9 210.1 53.9C202.7 56.9 197.4 63.5 195.9 71.3L175 174.6L71.7 195.4C63.9 197 57.3 202.4 54.3 209.7C51.3 217 52.1 225.5 56.5 232.2L114.7 320L56.5 407.8C52.1 414.5 51.3 422.9 54.3 430.3C57.3 437.7 63.9 443.1 71.7 444.6L175 465.4L195.9 568.7C197.5 576.5 202.9 583.1 210.2 586.1C217.5 589.1 226 588.3 232.7 583.9L320.5 525.7L408.3 583.9C415 588.3 423.4 589.1 430.8 586.1C438.2 583.1 443.6 576.5 445.1 568.7L466 465.5L569.2 444.6C577 443 583.6 437.6 586.6 430.3C589.6 423 588.8 414.5 584.4 407.8L526.2 320L584.4 232.2C588.8 225.5 589.6 217.1 586.6 209.7C583.6 202.3 577 196.9 569.2 195.4L465.8 174.6L445 71.3C443.4 63.5 438 57 430.6 53.9C423.2 50.8 414.8 51.7 408.1 56.1L320.4 114.3L232.6 56.1zM218.9 199.7L235.9 115.8L307.2 163.1C315.2 168.4 325.7 168.4 333.7 163.1L405 115.8L422 199.7C423.9 209.2 431.3 216.5 440.8 218.5L524.7 235.5L477.4 306.8C472.1 314.8 472.1 325.3 477.4 333.3L524.7 404.6L440.8 421.6C431.3 423.5 423.9 430.9 422 440.4L405 524.3L333.7 477C325.7 471.7 315.2 471.7 307.2 477L235.9 524.3L218.9 440.4C217 430.9 209.6 423.5 200.1 421.6L116.2 404.6L163.5 333.3C168.8 325.3 168.8 314.8 163.5 306.8L116.2 235.5L200.1 218.5C209.6 216.6 216.9 209.2 218.9 199.7zM271.6 320C271.6 293.3 293.3 271.6 320 271.6C346.7 271.6 368.4 293.3 368.4 320C368.4 346.7 346.7 368.4 320 368.4C293.3 368.4 271.6 346.7 271.6 320zM416.4 320C416.4 266.8 373.2 223.6 320 223.6C266.8 223.6 223.6 266.8 223.6 320C223.6 373.2 266.8 416.4 320 416.4C373.2 416.4 416.4 373.2 416.4 320z"/>
            </svg>
         </button>
         <h1 data-i18n="title">Baebol Kwestin</h1>
      </div>
      <p class="subtitle" data-i18n="subtitle">Askem eni kwestin long Baebol</p>
      <div class="card">
         <form id="queryForm">
            <label data-i18n="inputLabel">Raetem kwestin blong yu:</label>
            <div class="input-wrapper">
               <textarea id="question" data-i18n-placeholder="inputPlaceholder"></textarea>
               <button type="button" id="clearBtn" class="clear-circle">x</button>
            </div>
<div class="btn-row">
   <button type="submit" id="askBtn" data-i18n="askBtn">ASKEM Baebol</button>
	<button type="button" id="shareBtn" title="Serem" style="background:linear-gradient(145deg, rgba(245,156,85,0.6), rgba(230,126,34,0.5));color:var(--primary);width:56px;height:56px;min-width:56px;flex:0 0 56px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:50%;position:relative;z-index:5;margin:0 -24px;border:1px solid var(--card);box-shadow:0 4px 8px rgba(0,0,0,0.2),inset 0 -2px 4px rgba(0,0,0,0.1),inset 0 2px 4px rgba(255,255,255,0.3)">
		<svg viewBox="0 0 640 640" style="width:24px;height:24px;fill:var(--primary)">
			<path d="M342.6 73.4C330.1 60.9 309.8 60.9 297.3 73.4L169.3 201.4C156.8 213.9 156.8 234.2 169.3 246.7C181.8 259.2 202.1 259.2 214.6 246.7L288 173.3L288 384C288 401.7 302.3 416 320 416C337.7 416 352 401.7 352 384L352 173.3L425.4 246.7C437.9 259.2 458.2 259.2 470.7 246.7C483.2 234.2 483.2 213.9 470.7 201.4L342.7 73.4zM160 416C160 398.3 145.7 384 128 384C110.3 384 96 398.3 96 416L96 480C96 533 139 576 192 576L448 576C501 576 544 533 544 480L544 416C544 398.3 529.7 384 512 384C494.3 384 480 398.3 480 416L480 480C480 497.7 465.7 512 448 512L192 512C174.3 512 160 497.7 160 480L160 416z"/>
		</svg>
	</button>
   <button type="button" id="randomBtn" data-i18n="randomBtn">JUSUM Kwestin</button>
</div>
            <div id="historyBtn"><button type="button" id="showHistoryBtn" data-i18n="historyBtn">Ol kwestin (0)</button></div>
            <div id="randomQuestions"></div>
            <div id="debug"></div>
         </form>
      </div>
      <div id="answer">
	      <div id="answerHeader" style="display:none;justify-content:center;align-items:center;margin-bottom:8px;position:relative">
			  <button type="button" id="explainMoreBtn" data-i18n="explainMoreBtn" style="flex:1;margin-right:80px">Mekem ansa i longfala...</button>
	          <div style="display:flex;gap:8px;position:absolute;right:0">
	              <button type="button" id="shareAnswerBtn" title="Serem" style="background:transparent;border:none;cursor:pointer;padding:4px;display:flex;align-items:center">
	                  <svg viewBox="0 0 640 640" style="width:20px;height:20px;fill:var(--accent)">
	                      <path d="M342.6 73.4C330.1 60.9 309.8 60.9 297.3 73.4L169.3 201.4C156.8 213.9 156.8 234.2 169.3 246.7C181.8 259.2 202.1 259.2 214.6 246.7L288 173.3L288 384C288 401.7 302.3 416 320 416C337.7 416 352 401.7 352 384L352 173.3L425.4 246.7C437.9 259.2 458.2 259.2 470.7 246.7C483.2 234.2 483.2 213.9 470.7 201.4L342.7 73.4zM160 416C160 398.3 145.7 384 128 384C110.3 384 96 398.3 96 416L96 480C96 533 139 576 192 576L448 576C501 576 544 533 544 480L544 416C544 398.3 529.7 384 512 384C494.3 384 480 398.3 480 416L480 480C480 497.7 465.7 512 448 512L192 512C174.3 512 160 497.7 160 480L160 416z"/>
	                  </svg>
	              </button>
	              <button type="button" id="deleteAnswerBtn" title="Karemaot" style="background:transparent;border:none;cursor:pointer;padding:4px;display:flex;align-items:center">
	                  <svg viewBox="0 0 640 640" style="width:20px;height:20px;fill:var(--danger)">
	                      <path d="M262.2 48C248.9 48 236.9 56.3 232.2 68.8L216 112L120 112C106.7 112 96 122.7 96 136C96 149.3 106.7 160 120 160L520 160C533.3 160 544 149.3 544 136C544 122.7 533.3 112 520 112L424 112L407.8 68.8C403.1 56.3 391.2 48 377.8 48L262.2 48zM128 208L128 512C128 547.3 156.7 576 192 576L448 576C483.3 576 512 547.3 512 512L512 208L464 208L464 512C464 520.8 456.8 528 448 528L192 528C183.2 528 176 520.8 176 512L176 208L128 208zM288 280C288 266.7 277.3 256 264 256C250.7 256 240 266.7 240 280L240 456C240 469.3 250.7 480 264 480C277.3 480 288 469.3 288 456L288 280zM400 280C400 266.7 389.3 256 376 256C362.7 256 352 266.7 352 280L352 456C352 469.3 362.7 480 376 480C389.3 480 400 469.3 400 456L400 280z"/>
	                  </svg>
	              </button>
	          </div>
	      </div>
	      <div id="answerContent"></div>
	  </div>
      <div id="errorMessage"></div>
      <div id="customAlert">
         <div>
            <div class="alert-icon">‚úì</div>
            <div class="alert-message"></div>
            <button id="alertOkBtn">OK</button>
         </div>
      </div>
	  <div id="customConfirm">
		  <div>
			  <div class="confirm-icon">‚ö†Ô∏è</div>
			  <div class="confirm-message"></div>
			  <div class="confirm-buttons">
				  <button class="confirm-no" id="confirmNoBtn" data-i18n="confirmNo"<button id="langFab">Nogat</button>
				  <button class="confirm-yes" id="confirmYesBtn" data-i18n="confirmYes">Yes</button>
			  </div>
		  </div>
	  </div>	  
      <div id="welcomeVerse"></div>
      <div id="historyModal">
         <div>
            <button id="closeHistoryBtn">x</button>
            <h3 data-i18n="historyTitle" style="margin:0 0 4px;color:#e67e22;text-align:center">HISTRI: Ol Kwestin We Yu Askem Finis</h3>
			<p data-i18n="historySubtitle" style="margin:0 0 12px;text-align:center;font-size:0.85em;color:#7f8c8d;font-style:italic">(Tajem kwestin we yu wantem luk ansa blong hem.)</p>
			
            <div id="historyList"></div>
            <div style="display:flex;gap:10px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
               <button id="downloadHistoryBtn" data-i18n="downloadHistory" style="flex:1;background:#3498db;color:white;padding:10px;border-radius:8px;font-weight:bold">DAONLOTEM ol olfala ansa</button>
               <button id="clearHistoryBtn" data-i18n="clearHistory" style="flex:1;background:var(--danger);color:white;padding:10px;border-radius:8px;font-weight:bold">WAEPEMAOT ol olfala ansa</button>
            </div>
         </div>
      </div>
	  
		<footer class="footer">
		  Ross Webb 2.0 ¬© 2026
		</footer>

		<div id="langModal">
			<div>
				<h3 data-i18n="selectLanguage">Choose Language / Jusum Langwis / Choisir la langue</h3>
				<div class="lang-option" data-lang="en">üá¨üáß English</div>
				<div class="lang-option" data-lang="bi">üáªüá∫ Bislama</div>
				<div class="lang-option" data-lang="fr">üá´üá∑ Fran√ßais</div>
			</div>
		</div>

      <script>
		  if (location.hostname !== 'localhost' && !location.hostname.includes('127.0.0.')) {
		  // Production ‚Äì silence non-error logs
		  console.log = () => {};
		  console.debug = () => {};
		  // Optionally silence info-level, keep errors
		  // console.info = () => {};
		}
         document.addEventListener('DOMContentLoaded', () => {
             // === KEYS ===
             const GEMINI_KEY = atob("QUl6YVN5RDZXbzB1cHFmd0NiaUEwRTZpQ0tIclJ2Mm5EYTZfSTVN");
             marked.setOptions({ gfm: true, breaks: false, sanitize: false, headerIds: false });

			// === USER INTERFACE LANGUAGE OPTIONS === 
			const translations = {
			en: {
				title: "Bible Questions",
				subtitle: "Ask any question about the Bible",
				inputLabel: "Write your question:",
				inputPlaceholder: "Type in your question here. It can be in Bislama, English or French",
				askBtn: "ASK the Bible",
				randomBtn: "CHOOSE a Question",
				historyBtn: "HISTORY: Past questions",
				explainMoreBtn: "Make answer longer...",
				shareTooltip: "Share",
				deleteTooltip: "Delete",
				confirmNo: "No",
				confirmYes: "Yes",
				selectLanguage: "Choose Language",
				historyTitle: "HISTORY: Questions You've Asked",
				historySubtitle: "(Tap a question to see its answer.)",
				downloadHistory: "DOWNLOAD old answers",
				clearHistory: "DELETE all old answers",
				noAnswersToDownload: "No answers to download!",
				noAnswersToDelete: "No answers to delete!",
				confirmDeleteAll: "Delete all past answers? You cannot undo this!",
				allAnswersDeleted: "All old answers deleted!",
				answersSaved: "Answers saved to a file",
				answerCopied: "Answer copied! You can paste it elsewhere.",
				shareError: "Sorry - cannot share. Try again.",
				linkCopied: "Link copied! You can send it to others.",
				confirmDeleteAnswer: "Delete this answer?",
				confirmDeleteQuestion: "Delete",
				noInternet: "‚ö†Ô∏è Sorry, no internet! Turn on internet, then try again.",
				offlineError: "‚ö†Ô∏è Sorry! Internet not working - try again",
				waitMessage: "Wait a moment...",
				loading: "Loading...",
				shareBtn: "SHARE",
				darkModeTooltip: "Dark Mode",
				languageTooltip: "Language",
			},
			bi: {
				title: "Baebol Kwestin",
				subtitle: "Askem eni kwestin long Baebol",
				inputLabel: "Raetem kwestin blong yu:",
				inputPlaceholder: "Raetem kwestin blong yu long ples ia. Yu save raetem long Bislama, Englis o Franis",
				askBtn: "ASKEM Baebol",
				randomBtn: "JUSUM Kwestin",
				historyBtn: "HISTRI: Ol kwestin we yu askem finis",
				explainMoreBtn: "Mekem ansa i longfala...",
				shareTooltip: "Serem",
				deleteTooltip: "Karemaot",
				confirmNo: "Nogat",
				confirmYes: "Yes",
				selectLanguage: "Jusum Langwis",
				historyTitle: "HISTRI: Ol Kwestin We Yu Askem Finis",
				historySubtitle: "(Tajem kwestin we yu wantem luk ansa blong hem.)",
				downloadHistory: "DAONLOTEM ol olfala ansa",
				clearHistory: "WAEPEMAOT ol olfala ansa",
				noAnswersToDownload: "Nogat eni ansa blong daonlotem!",
				noAnswersToDelete: "Nogat ansa blong waepemaot!",
				confirmDeleteAll: "Karemaot ol ansa blo bifo? Yu no save karembak!",
				allAnswersDeleted: "Ol olfala ansa i aot finis!",
				answersSaved: "Ol ansa i daonlot long wan fael finis",
				answerCopied: "Ansa i kopi finis! Yu save pestem long narafala ples.",
				shareError: "Sore - no save serem. Traem bakegen.",
				linkCopied: "Link i kopi finis! Yu save sendem long ol narafala man.",
				confirmDeleteAnswer: "Karemaot ansa ia?",
				confirmDeleteQuestion: "Karemaot",
				noInternet: "‚ö†Ô∏è Sore, nogat intanet! Onem intanet, afta traem bakegen.",
				offlineError: "‚ö†Ô∏è Sore! Intanet i no wok - traem bakegen",
				waitMessage: "Wet smol...",
				loading: "Loading...",
				shareBtn: "SEREM",
				darkModeTooltip: "Blak",
				languageTooltip: "Lanwis"
			},
			fr: {
				title: "Questions Bibliques",
				subtitle: "Posez n'importe quelle question sur la Bible",
				inputLabel: "√âcrivez votre question:",
				inputPlaceholder: "Tapez une question.",
				askBtn: "DEMANDER √† la Bible",
				randomBtn: "CHOISIR une Question",
				historyBtn: "HISTORIQUE: Questions pass√©es",
				explainMoreBtn: "Allonger la r√©ponse...",
				shareTooltip: "Partager",
				deleteTooltip: "Supprimer",
				confirmNo: "Non",
				confirmYes: "Oui",
				selectLanguage: "Choisir la langue",
				historyTitle: "HISTORIQUE: Questions Pos√©es",
				historySubtitle: "(Appuyez sur une question pour voir sa r√©ponse.)",
				downloadHistory: "T√âL√âCHARGER anciennes r√©ponses",
				clearHistory: "EFFACER toutes les anciennes r√©ponses",
				noAnswersToDownload: "Pas de r√©ponses √† t√©l√©charger!",
				noAnswersToDelete: "Pas de r√©ponses √† supprimer!",
				confirmDeleteAll: "Supprimer toutes les r√©ponses pass√©es? Vous ne pouvez pas annuler!",
				allAnswersDeleted: "Toutes les anciennes r√©ponses supprim√©es!",
				answersSaved: "R√©ponses enregistr√©es dans un fichier",
				answerCopied: "R√©ponse copi√©e! Vous pouvez la coller ailleurs.",
				shareError: "D√©sol√© - impossible de partager. R√©essayez.",
				linkCopied: "Lien copi√©! Vous pouvez l'envoyer √† d'autres.",
				confirmDeleteAnswer: "Supprimer cette r√©ponse?",
				confirmDeleteQuestion: "Supprimer",
				noInternet: "‚ö†Ô∏è D√©sol√©, pas d'internet! Activez internet, puis r√©essayez.",
				offlineError: "‚ö†Ô∏è D√©sol√©! Internet ne fonctionne pas - r√©essayez",
				waitMessage: "Un instant...",
				loading: "Chargement...",
				shareBtn: "PARTAGER",
				darkModeTooltip: "Mode sombre",
				languageTooltip: "Langue",
			}
		};

			let currentLang = localStorage.getItem('language') || 'bi'; // Default to Bislama			 
         
             // === ELEMENTS ===
			 const langFab = document.getElementById('langFab');
			 const langModal = document.getElementById('langModal');
             const darkFab = document.getElementById('darkFab');
             const moon = document.getElementById('moon');
             const sun = document.getElementById('sun');
             const form = document.getElementById('queryForm');
             const questionInput = document.getElementById('question');
             const askBtn = document.getElementById('askBtn');
             const randomBtn = document.getElementById('randomBtn');
             const randomDiv = document.getElementById('randomQuestions');
             const answerDiv = document.getElementById('answer');
             const answerHeader = document.getElementById('answerHeader');
             const answerContent = document.getElementById('answerContent');
             const explainMoreBtn = document.getElementById('explainMoreBtn');
             const clearBtn = document.getElementById('clearBtn');
             const showHistoryBtn = document.getElementById('showHistoryBtn');
             const welcomeVerse = document.getElementById('welcomeVerse');
             const historyModal = document.getElementById('historyModal');
             const historyList = document.getElementById('historyList');
             const closeHistoryBtn = document.getElementById('closeHistoryBtn');
			 const debugDiv = document.getElementById('debug');
			 const errorMessage = document.getElementById('errorMessage');
			 const customAlert = document.getElementById('customAlert');
			 const alertOkBtn = document.getElementById('alertOkBtn');
			 let currentQuestion = '';
			 let currentAnswer = '';
			 let isAutoSubmit = false;
			 
			 // === HELPERS ===

			// Convert markdown answer to WhatsApp-friendly plain text
			function formatAnswerForShare(markdown) {
			  return markdown
				.replace(/^#{1,6}\s+(.+)$/gm, '*$1*')      // headings -> *Bold*
				.replace(/\*\s*"(.+?)"\s*\*/g, '_$1_')     // *"Quote text"* -> _Quote text_
				.replace(/\*\*([^*]+?)\*\*/g, '*$1*')      // **Reference** -> *Reference*
				.replace(/^[-*+]\s+/gm, '‚Ä¢ ')              // -, *, + lists -> ‚Ä¢ 
				.replace(/^\d+\.\s+/gm, '')                // Remove numbered list markers
				.trim();
			}
         
         // === CUSTOM ALERT FUNCTION ===
         function showAlert(message, icon = '‚úì') {
             const alertIcon = customAlert.querySelector('.alert-icon');
             const alertMessage = customAlert.querySelector('.alert-message');
             alertIcon.textContent = icon;
             alertMessage.textContent = message;
             customAlert.style.display = 'flex';
         }
         
         alertOkBtn.onclick = () => { customAlert.style.display = 'none'; };
         customAlert.onclick = (e) => { if (e.target === customAlert) customAlert.style.display = 'none'; };
		 
		// === CUSTOM CONFIRM FUNCTION ===
		function showConfirm(message) {
			return new Promise((resolve) => {
				const customConfirm = document.getElementById('customConfirm');
				const confirmMessage = customConfirm.querySelector('.confirm-message');
				const confirmYesBtn = document.getElementById('confirmYesBtn');
				const confirmNoBtn = document.getElementById('confirmNoBtn');
				
				confirmMessage.textContent = message;
				customConfirm.style.display = 'flex';
				
				const handleYes = () => {
					customConfirm.style.display = 'none';
					cleanup();
					resolve(true);
				};
				
				const handleNo = () => {
					customConfirm.style.display = 'none';
					cleanup();
					resolve(false);
				};
				
				const cleanup = () => {
					confirmYesBtn.removeEventListener('click', handleYes);
					confirmNoBtn.removeEventListener('click', handleNo);
					customConfirm.removeEventListener('click', handleClickOutside);
				};
				
				const handleClickOutside = (e) => {
					if (e.target === customConfirm) handleNo();
				};
				
				confirmYesBtn.addEventListener('click', handleYes);
				confirmNoBtn.addEventListener('click', handleNo);
				customConfirm.addEventListener('click', handleClickOutside);
			});
		}
         
             // === DARK MODE ===
             darkFab.onclick = () => {
                 document.body.classList.toggle('dark-mode');
                 const isDark = document.body.classList.contains('dark-mode');
                 moon.style.display = isDark ? 'none' : 'block';
                 sun.style.display = isDark ? 'block' : 'none';
                 localStorage.setItem('darkMode', isDark);
             };
             if (localStorage.getItem('darkMode') === 'true') {
                 document.body.classList.add('dark-mode');
                 moon.style.display = 'none';
                 sun.style.display = 'block';
             }
         
			// SHARE BUTTON ‚Äì just share app link
			  document.getElementById('shareBtn').onclick = async () => {
			  const appLink = window.location.origin + window.location.pathname;
			  const shareText =
				`Tajem link ia ${appLink} blong instolem Baebol Kwestin app.\n\n` +
				`Askem eni kwestin long Baebol ‚Äì Bible Questions App for Vanuatu.`;

			  try {
				// Copy link + message to clipboard
				await navigator.clipboard.writeText(shareText);

				// Try native share if available
				if (navigator.share) {
				  await navigator.share({
					title: 'Baebol Kwestin',
					text: shareText // no url: field to keep body text in desktop email clients
				  });
				} else {
				  showAlert('Link i kopi finis! Yu save sendem long ol narafala man.');
				}
			  } catch (err) {
				if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
				  showAlert('Sore - no save serem. Traem bakegen.');
				}
			  }
			};

         
			// === SHARE FUNCTION ===
			async function shareAnswer(question, answer) {
			  const plainAnswer = formatAnswerForShare(answer);
			  const appLink = window.location.origin + window.location.pathname;
			  const shareText = `Tajem link ia ${appLink} blong instolem app we i mekem ansa ia.\n\n---\nKWESTIN: ${question}\n\nANSA:\n${plainAnswer}\n\n--- Baebol Kwestin App ---`;
			  try {
				await navigator.clipboard.writeText(shareText);
				if (navigator.share) {
				  await navigator.share({ title: `Baebol Kwestin - ${question}`, text: shareText });
				} else {
				  const t = translations[currentLang];
				  showAlert(t.answerCopied);
				}
			  } catch (err) {
				if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
				  const t = translations[currentLang];
				  showAlert(t.answerCopied);
				}
			  }
			}
		 
             // === SYSTEM PROMPT ===
             const systemPrompt = `You are a kind Bible teacher in Vanuatu.
         Answer in SIMPLE, ACTIVE English that a 13-year-old can read and understand.
         When there is a negative concept like 'not innocent' also give the positive like 'guilty'
         Answers follow solid REFORMED theology.
         Do NOT contradict these truths:
         - God created everything and is sovereign.
         - Every person sins and needs forgiveness.
         - Jesus, God's Son, died on the cross to pay for sin.
         - He rose again to give new life.
         - Salvation is by faith in Jesus alone, not works.
         - The Holy Spirit helps us obey and love others.
         - The Bible is God's true Word.
         - Jesus will return to judge; believers go to heaven, unbelievers to hell (as the Bible teaches).
         **FORMAT EXACTLY LIKE THIS:**
         Do *NOT* start with an introductory greeting
         ## Main Idea
         ### Step 1: Do This
         - bullet points
         - keep short
         ### Step 2: Remember This
         Followed by at least 3 supporting verses from NIrV version of the Bible. Put each verse on its own line with a blank line between them, styled like this:
         
         **John 3:16** *"For God loved the world so much that he gave his only Son, so that everyone who believes in him may not die but have eternal life."*
         
         **Romans 3:23** *"Everyone has sinned. No one measures up to God's glory."*
         End with one short sentence of hope or encouragement.
         Keep under 350 words. Cite 3+ verses from the NIrV version of the Bible. Be warm, clear, and kind.`;
         
             // === FETCH WITH TIMEOUT ===
         async function fetchWithTimeout(url, options = {}, timeout = 15000) {
         const controller = new AbortController();
         const id = setTimeout(() => controller.abort(), timeout);
                 try {
                     const res = await fetch(url, { ...options, signal: controller.signal });
                     clearTimeout(id);
                     return res;
                 } catch (e) {
                     clearTimeout(id);
                     console.error("Fetch failed:", e.message);
                     throw e;
                 }
             }
         
         // === ANSWER GENERATOR ===
		async function getAnswer(q, isExplainMore = false) {
		// Determine target language based on UI
		// For 'bi' (Bislama) and 'en' (English), both get English answers
		let languageInstruction = "Answer in SIMPLE, ACTIVE English that a 13-year-old can read and understand.";
		if (currentLang === 'fr') {
			languageInstruction = "Answer in SIMPLE, ACTIVE French (fran√ßais simple) that a 13-year-old can read and understand.";
		}

         // Override system prompt for detailed study mode
		const activeSystemPrompt = isExplainMore 
		? systemPrompt
		.replace('Answer in SIMPLE, ACTIVE English that a 13-year-old can read and understand.', languageInstruction)
		.replace('Keep under 350 words', 'Write 600-800 words')
		.replace('Cite 3+ verses', 'Include 6-8 verses from NIrV, each on its own line with blank lines between them')
		.replace('**FORMAT EXACTLY LIKE THIS:**', '**BIBLE STUDY FORMAT:**')
		: systemPrompt.replace('Answer in SIMPLE, ACTIVE English that a 13-year-old can read and understand.', languageInstruction);

         
         const fullQ = isExplainMore
         ? q + "\n\n**BIBLE STUDY FORMAT** - Follow this structure exactly:\n\n**1. A SUMMARY ANSWER FIRST**\n\n(Blank line after heading)\n\nBriefly state the problem/question and give a one-sentence summary answer.\n\n**2. WHAT THE BIBLE SAYS**\n\n(Blank line after heading)\n\nLet's see what the Bible says about this:\n\n(Blank line, then each verse on this pattern:)\n\n**Verse Reference** *\"Full verse text from NIrV\"*\n\nOne sentence explaining what this verse teaches us.\n\n(BLANK LINE between each verse block)\n\n**3. UNDERSTANDING THIS DEEPER**\n\n(Blank line after heading)\n\nNow expand on the answer in 3-4 paragraphs:\n- What does this mean for us?\n- How does this change how we think?\n- Why is this important?\n\n(Blank line between paragraphs)\n\n**4. LIVING THIS OUT**\n\n(Blank line after heading)\n\nGive 3-4 practical steps:\n- First step\n- Second step\n- Third step\n\n**5. REMEMBER THIS**\n\n(Blank line after heading)\n\nEnd with one encouraging sentence.\n\nCRITICAL: Put blank lines after EVERY heading and between EVERY verse block. Total: 500-700 words. Keep language SIMPLE (13-year-old level)."
         : q;
         
         // Try Gemini API
         try {
         const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
         contents: [{ parts: [{ text: activeSystemPrompt + "\n\nQuestion: " + fullQ }] }],
         generationConfig: { maxOutputTokens: isExplainMore ? 4500 : 2800, temperature: 0.7 },
         safetySettings: [
         { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
         { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
         { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
         { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }
         ]
         })
         }, isExplainMore ? 30000 : 15000);
         
         if (res.ok) {
         const data = await res.json();
         const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
         if (text && text.length > 150) {
         debugDiv.textContent = "Gemini 2.5 Flash";
         return { text, source: 'Gemini' };
         }
         }
         } catch (e) {
         console.error("Gemini failed:", e.message);
         }
         
         // Fallback if Gemini fails
         debugDiv.textContent = "Offline (no connection)";
		 const t = translations[currentLang];
		 errorMessage.textContent = t.noInternet;
         errorMessage.style.display = 'block';
         return {
         text: ``,
         source: 'fallback'
         };
         }
         
             // === SUBMIT ===
         const handleSubmit = async (q) => {
         if (!q) return;
         currentQuestion = q;
         askBtn.disabled = true; 
		 const t = translations[currentLang];
		 askBtn.textContent = t.waitMessage;
         askBtn.classList.add('button-loading');
         answerDiv.style.display = 'none'; answerHeader.style.display = 'none';
         answerContent.innerHTML = ''; welcomeVerse.style.display = 'none';
         errorMessage.style.display = 'none'; // Hide any previous errors
         debugDiv.textContent = t.loading;
		 const result = await getAnswer(q);
	 	 answerContent.innerHTML = marked.parse(result.text);
		 // Only store real answers, not fallback
		 if (result.source !== 'fallback') {
			currentAnswer = result.text;
			answerHeader.style.display = 'flex';
			answerDiv.style.display = 'block';
			const verseMatch = result.text.match(/\*\*([A-Za-z0-9 ]+:\d+)\*\* \*"([^"]+)"\*/);
			const verse = verseMatch ? { ref: verseMatch[1], text: verseMatch[2] } : null;
			saveAnswer(q, result.text, verse);
			// Slide the page up so the answer is as visible as possible
			setTimeout(() => {
				answerDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
			}, 80);
		 } else {
			 // Don't show answer header/div for fallback
			 answerHeader.style.display = 'none';
			 answerDiv.style.display = 'none';
		 }
         askBtn.disabled = false; 
         askBtn.textContent = t.askBtn;
         askBtn.classList.remove('button-loading');
                 isAutoSubmit = false;
             };
		 form.addEventListener('submit', e => {
			e.preventDefault();
			if (isAutoSubmit) return;
			const q = questionInput.value.trim();
			if (!q) return;
			questionInput.blur(); // Dismiss keyboard on mobile
			handleSubmit(q);
		 });

		 // Allow ENTER key to submit question (Shift+Enter for new line)
		 questionInput.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				const q = questionInput.value.trim();
				if (q) {
					questionInput.blur(); // Dismiss keyboard on mobile
					handleSubmit(q);
				}
			}
		 });
         
		const ANIMISM_SEED = [
		    { en: "Is it okay to try and talk with dead people?", bi: "Hemi oraet blong traem toktok wetem ol ded man?" },
		    { en: "Can spirits in the bush really hurt me?", bi: "Rabis speret i save mekem nogud mi?" },
		    { en: "Is it wrong to use kastom medicine and Christian prayers together?", bi: "Hemi oraet blong mi yusum kastom meresin mo prea long God semtaem?" },
		    { en: "What does the Bible say about people who see spirits or other hidden things?", bi: "Wanem tijing blong Baebol long saed blong ol man we oli stap luk ol samting long speret wol?" },
		    { en: "Should a Christian go to watch or join a kastom dance?", bi: "Hemi oraet blong ol kristin man i go blong wajem o joen long kastom danis?" },
		    { en: "What does the Bible say about nakaemas? (sorcery)", bi: "Wanem tijing blong Baebol long saed blong nakaemas?" },
		    { en: "Is it okay to destroy a house where someone died?", bi: "Hemi oraet blong brekemdaon wan haos we wan man i bin ded insaed long hem?" },
		    { en: "Can a Christian use love magic?", bi: "Majik blong mekem man o woman i laekem nara man o woman i oraet blong ol kristin i yusum o no?" },
		    { en: "What does the Bible say about dreams from spirits?", bi: "Baebol i talem wanem long saed blong ol drim we i stap kam long ol rabis speret?" },
		    { en: "Is it wrong to pay bride price?", bi: "Hemi stret blong pem woman blong mared long hem?" },
		    { en: "Can spirits follow you if you move villages?", bi: "Ol rabis speret i save folem yu sipos yu muvaot long vilej blong yu?" },
		    { en: "What does the Bible say about tabu places?", bi: "Baebol i talem wanem long saed blong ol tabu ples?" },
		    { en: "Is it okay to eat food offered to spirits?", bi: "Hemi oraet blong ol kristin man i kakae ol kakae we ol nara man i bin givim finis long ol speret blong oli save kakae?" },
		    { en: "Does it matter if a person wearing kastom clothes comes to church?", bi: "Olsem wanem sipos wan man o woman i kam lo jyos be hemi werem kastom klos?" },
		    { en: "What does the Bible say about people who do poison (harming by sorcery)?", bi: "Baebol i talem wanem long saed blong ol man we oli stap mekem posen?" },
		    { en: "Is it wrong to go to a kastom healer?", bi: "Hemi stret blong go luk ol man we oli stap mekem kastom meresin o no?" },
		    { en: "Can Christians dance in kastom ceremonies?", bi: "Hemi oraet blong kristin man i danis long kastom danis?" },
		    { en: "What does the Bible say about ancestors watching us?", bi: "Baebol i talem wanem long saed blong ol olfala we oli ded finis be oli stap lukluk yumi yet?" },
		    { en: "Is it okay to keep kastom carvings in the house?", bi: "Hemi oraet blong gat ol samting blong kastom (olsem we oli mekem long wud) insaed long haos blong yumi?" },
		    { en: "Can a Christian marry someone who follows kastom?", bi: "Hemi oraet blong wan kristin i mared long wan man we hemi stap folem kastom nomo?" }
		];
         const GENERAL_SEED = [
			 "Why do I still sin sometimes even after trusting Jesus?",
			 "What is the real thinking behind my sins? Why do I sin?",
			 "How can talking to God every day make my life better?",
			 "What changed in me the moment I accepted Jesus as my Lord and Saviour?",
			 "Why does God give me what I don't deserve?",
			 "Do I have to keep living a good life so God will not turn away from me?",
			 "Why should I always get together with other strong Christians?",
			 "What do I do when a part of the Bible is hard to understand?",
			 "Why can't good actions alone make God accept a person?",
			 "How does God help me fight bad habits day by day?",
			 "Help me learn how to pray more regularly?",
			 "Why do I have to go to church every week?",
			 "I have heard that Jesus' cross is like the key that opens God's door for me? True?",
			 "What happens when God chooses a person to follow Him?",
			 "What is the best way to read the Bible?",
			 "How does God show his kindness to me after I believe?",
			 "How do other believers help you grow stronger in faith?",
			 "Why does trusting Jesus alone save me from going to hell?",
			 "What daily step gets me closer to living like Jesus?",
			 "How does the Bible light up good and bad choices?",
			 "How does God make everything good flow from His love?",
			 "Why share prayer needs with my church group?",
			 "If my life is hard, does that mean God is cross with me?",
			 "What fights inside you after you start following Jesus?",
			 "Are all churches the same? Which one should I go to?",
			 "How can you obey Jesus' words in everyday life?",
			 "What changes in me when God makes me his child?",
			 "Why does the Bible talk about eternal life as though it is a good thing?",
			 "How can I stop being afraid to die?"
         ];
         
         // Initialize pools
         let generalPool = [...GENERAL_SEED];
         let usedAnimism = JSON.parse(localStorage.getItem('usedAnimism') || '[]');
         let isGeneratingQuestion = false;
         
		const showQuestionButtons = (qs) => {
			randomDiv.innerHTML = '';
			qs.forEach(q => {
				const b = document.createElement('button');
				b.className = 'random-q-btn';
				// Display Bislama if available, otherwise English
				b.textContent = q.bi || q;
				b.onclick = () => {
					// Use English for the AI query
					const aiQuestion = q.en || q;
					questionInput.value = aiQuestion;
					questionInput.dispatchEvent(new Event('input'));
					randomDiv.style.display = 'none';
					isAutoSubmit = true;
					handleSubmit(aiQuestion);
				};
				randomDiv.appendChild(b);
			});
			randomDiv.style.display = 'block';
		};
         
		randomBtn.onclick = () => {
			// Get 1 animism question (track usage) - now tracking English version
			const availableAnimism = ANIMISM_SEED.filter(q => !usedAnimism.includes(q.en));
			if (availableAnimism.length === 0) {
				usedAnimism = []; // Reset when all used
				localStorage.setItem('usedAnimism', JSON.stringify(usedAnimism));
			}
			const animismQ = availableAnimism.length > 0 
				? availableAnimism[Math.floor(Math.random() * availableAnimism.length)]
				: ANIMISM_SEED[Math.floor(Math.random() * ANIMISM_SEED.length)];
			usedAnimism.push(animismQ.en); // Track by English version
			localStorage.setItem('usedAnimism', JSON.stringify(usedAnimism));
			
			// Get 4 general questions from pool (these stay as strings)
			const shuffled = generalPool.sort(() => 0.5 - Math.random());
			const selectedGeneral = shuffled.slice(0, 4);
			
			// Show all 5 questions
			showQuestionButtons([animismQ, ...selectedGeneral]);
			
			// Replenish pool if needed (async in background)
			if (generalPool.length < 10 && !isGeneratingQuestion) {
				replenishPool();
			}
		};
         
         // Background function to add AI questions to pool
         async function replenishPool() {
         isGeneratingQuestion = true;
         try {
         const prompt = "Generate 1 simple Bible question for a new Christian in Vanuatu. The question should cover conservative theology topics like salvation, grace, sanctification, God's sovereignty, election, prayer, or Scripture. Make it practical, conversational, and under 20 words. Return ONLY the question, no numbering or extra text.";
         
         const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
         contents: [{ parts: [{ text: prompt }] }],
         generationConfig: { maxOutputTokens: 100, temperature: 0.9 }
         })
         }, 10000);
         
         if (res.ok) {
         const data = await res.json();
         const newQ = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
         if (newQ && newQ.length > 10 && newQ.length < 150) {
         generalPool.push(newQ);
         console.log('Added new question to pool:', newQ);
         }
         }
         } catch (e) {
         console.log('Failed to generate question, pool will use seed questions');
         }
         isGeneratingQuestion = false;
         }
         
         // === HISTORY & WELCOME ===
         let history = [];
         try {
         const raw = localStorage.getItem('bibleHistory');
         if (raw) history = JSON.parse(raw).filter(i => i && i.q && (i.rawAnswer || i.a));
         } catch (e) {}
         const saveAnswer = (q, rawMarkdown, verse, keepDate = null, insertAfterDate = null) => {
         const newItem = { q, rawAnswer: rawMarkdown, date: keepDate || new Date().toLocaleString('en-GB') };
         if (verse) newItem.verse = verse;
         
         // If insertAfterDate is provided, insert right after that item
         if (insertAfterDate) {
         const insertIndex = history.findIndex(h => h.date === insertAfterDate);
         if (insertIndex !== -1) {
         history.splice(insertIndex + 1, 0, newItem);
         } else {
         history = [newItem, ...history];
         }
         } else {
         history = [newItem, ...history];
         }
         
         history = history.slice(0, 200);
         try { localStorage.setItem('bibleHistory', JSON.stringify(history)); } catch(e) {}
         updateHistoryBtn();
         showWelcome();
         };
			const updateHistoryBtn = () => {
				const cnt = history.length;
				const t = translations[currentLang];
				showHistoryBtn.textContent = `${t.historyBtn} (${cnt})`;  // ‚Üê Use translation
				document.getElementById('historyBtn').style.display = cnt ? 'block' : 'none';
			};
             const showWelcome = () => {
                 welcomeVerse.style.display = 'none';
                 if (history.length > 0 && history[0].verse) {
                     const v = history[0].verse;
                     welcomeVerse.innerHTML = `<strong>${v.ref}</strong><br><em>${v.text}</em>`;
                 } else {
                     const v = { ref: "John 3:16", text: "For God loved the world so much that he gave his one and only Son, so that everyone who believes in him may not die but have eternal life." };
                     welcomeVerse.innerHTML = `<strong>${v.ref}</strong><br><em>${v.text}</em>`;
                 }
                 welcomeVerse.style.display = 'block';
             };
         
		 showHistoryBtn.onclick = () => {
		 const t = translations[currentLang];
		 historyList.innerHTML = '';

		 history.forEach((item, index) => {
         const itemDiv = document.createElement('div');
         itemDiv.className = 'history-item';
         
         // Create wrapper for question and delete button
         const questionWrapper = document.createElement('div');
         questionWrapper.style.cssText = 'position:relative;padding-right:32px';
         
         const questionDiv = document.createElement('div');
         questionDiv.className = 'history-question';
         // Check if question ends with '-longfala' and format accordingly
         const displayTitle = item.q.endsWith(' -longfala') 
         ? item.q.replace(' -longfala', ' <em style="font-style:italic;font-weight:normal">-longfala</em>')
         : item.q;
         questionDiv.innerHTML = `
         <p style="margin:0;font-weight:bold;color:var(--primary)">${displayTitle}</p>
         <p style="margin:4px 0 0;font-size:.9em;color:#7f8c8d">${item.date}</p>
         `;
         
		 // Create share button
		 const shareBtn = document.createElement('button');
		 shareBtn.className = 'share-item-btn';
		 shareBtn.innerHTML = '<svg viewBox="0 0 640 640" style="width:18px;height:18px;fill:var(--accent)"><path d="M342.6 73.4C330.1 60.9 309.8 60.9 297.3 73.4L169.3 201.4C156.8 213.9 156.8 234.2 169.3 246.7C181.8 259.2 202.1 259.2 214.6 246.7L288 173.3L288 384C288 401.7 302.3 416 320 416C337.7 416 352 401.7 352 384L352 173.3L425.4 246.7C437.9 259.2 458.2 259.2 470.7 246.7C483.2 234.2 483.2 213.9 470.7 201.4L342.7 73.4zM160 416C160 398.3 145.7 384 128 384C110.3 384 96 398.3 96 416L96 480C96 533 139 576 192 576L448 576C501 576 544 533 544 480L544 416C544 398.3 529.7 384 512 384C494.3 384 480 398.3 480 416L480 480C480 497.7 465.7 512 448 512L192 512C174.3 512 160 497.7 160 480L160 416z"/></svg>';
		 shareBtn.title = 'Serem';
		 shareBtn.style.cssText = 'background:transparent;border:none;width:24px;height:24px;min-width:24px;max-width:24px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;line-height:1;padding:0;position:absolute;top:8px;right:32px';
         
		 // Create delete button separately
		 const deleteBtn = document.createElement('button');
		 deleteBtn.className = 'delete-item-btn';
		 deleteBtn.innerHTML = '<svg viewBox="0 0 640 640" style="width:18px;height:18px;fill:var(--danger)"><path d="M262.2 48C248.9 48 236.9 56.3 232.2 68.8L216 112L120 112C106.7 112 96 122.7 96 136C96 149.3 106.7 160 120 160L520 160C533.3 160 544 149.3 544 136C544 122.7 533.3 112 520 112L424 112L407.8 68.8C403.1 56.3 391.2 48 377.8 48L262.2 48zM128 208L128 512C128 547.3 156.7 576 192 576L448 576C483.3 576 512 547.3 512 512L512 208L464 208L464 512C464 520.8 456.8 528 448 528L192 528C183.2 528 176 520.8 176 512L176 208L128 208zM288 280C288 266.7 277.3 256 264 256C250.7 256 240 266.7 240 280L240 456C240 469.3 250.7 480 264 480C277.3 480 288 469.3 288 456L288 280zM400 280C400 266.7 389.3 256 376 256C362.7 256 352 266.7 352 280L352 456C352 469.3 362.7 480 376 480C389.3 480 400 469.3 400 456L400 280z"/></svg>';
		 deleteBtn.title = 'Karemaot';
		 deleteBtn.style.cssText = 'background:transparent;border:none;width:24px;height:24px;min-width:24px;max-width:24px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;line-height:1;padding:0;position:absolute;top:8px;right:0px';
         
		 // Add share button handler
		 shareBtn.onclick = (e) => {
		 e.stopPropagation(); // Prevent opening the answer
		 // Remove '-longfala' suffix for cleaner sharing
		 const cleanQuestion = item.q.replace(' -longfala', '');
		 console.log('DEBUG history answer:', item.rawAnswer, item.a);  // ‚Üê ADD THIS
		 shareAnswer(cleanQuestion, item.rawAnswer || item.a || '');
		 };
         
         // Add delete button handler
         deleteBtn.onclick = async (e) => {
         e.stopPropagation(); // Prevent opening the answer
		 const t = translations[currentLang];
		 if (await showConfirm(`${t.confirmDeleteQuestion} "${item.q}"?`)) {
         // Remove from history array
         const histIndex = history.findIndex(h => h.q === item.q && h.date === item.date);
         if (histIndex !== -1) {
         history.splice(histIndex, 1);
         try { 
         localStorage.setItem('bibleHistory', JSON.stringify(history)); 
         updateHistoryBtn();
         showWelcome();
         } catch(e) {}
         // Remove from display
         itemDiv.remove();
         }
         }
         };
         
         const answerDiv = document.createElement('div');
         answerDiv.className = 'history-answer';
         const renderedAnswer = marked.parse(item.rawAnswer || item.a || '');
         answerDiv.innerHTML = renderedAnswer;
         
         // Create extend button for THIS item (hidden by default)
         const extendBtnContainer = document.createElement('div');
         extendBtnContainer.className = 'item-extend-btn';
         extendBtnContainer.style = 'display:none;text-align:center;margin:12px 0;padding:12px;background:var(--border);border-radius:8px';
         const extendBtn = document.createElement('button');
         extendBtn.textContent = t.explainMoreBtn;
         extendBtn.style = 'background:#e67e22;color:white;padding:10px 20px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:1em';
         extendBtn.onmouseover = () => extendBtn.style.background = '#d35400';
         extendBtn.onmouseout = () => extendBtn.style.background = '#e67e22';
         extendBtnContainer.appendChild(extendBtn);
         
         // Toggle expand/collapse on click
         questionDiv.onclick = () => {
             const wasExpanded = answerDiv.classList.contains('expanded');
             
             // Collapse all other answers and hide their buttons
             document.querySelectorAll('.history-answer').forEach(a => a.classList.remove('expanded'));
             document.querySelectorAll('.item-extend-btn').forEach(b => b.style.display = 'none');
             
         if (!wasExpanded) {
         answerDiv.classList.add('expanded');
         // Only show extend button if question doesn't already end with '-longfala'
         if (!item.q.endsWith(' -longfala')) {
         extendBtnContainer.style.display = 'block';
         }
                 
                 // Scroll the button into view
                 setTimeout(() => extendBtnContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                 
                 // Set up extend button click handler
                 extendBtn.onclick = async () => {
                     extendBtn.disabled = true;
                     const t = translations[currentLang];
					 extendBtn.textContent = t.waitMessage;
                     extendBtn.classList.add('button-loading');
                     
                     const result = await getAnswer(item.q, true);
                     
                     if (result.source === 'fallback') {
						 const t = translations[currentLang];
						 errorMessage.textContent = t.noInternet;
                         errorMessage.style.display = 'block';
                         setTimeout(() => errorMessage.style.display = 'none', 3000);
                         extendBtn.disabled = false;
						 extendBtn.textContent = t.explainMoreBtn;
                         extendBtn.classList.remove('button-loading');
                     } else {
                         // Extract verse for the extended answer
                         const verseMatch = result.text.match(/\*\*([A-Za-z0-9 ]+:\d+)\*\* \*"([^"]+)"\*/);
                         const verse = verseMatch ? { ref: verseMatch[1], text: verseMatch[2] } : null;
                         
                         // Save as NEW history entry with modified question, keeping original date and position
                         const longQuestion = item.q + ' -longfala';
                         saveAnswer(longQuestion, result.text, verse, item.date, item.date);
                         
                         // Close and reopen modal, then auto-open the new long answer
                         historyModal.style.display = 'none';
                         setTimeout(() => {
                             showHistoryBtn.click();
                             // Wait for modal to render, then click the first matching longfala question
                             setTimeout(() => {
                                 const longAnswers = document.querySelectorAll('.history-question');
                                 for (let qa of longAnswers) {
                                     if (qa.textContent.includes(item.q) && qa.textContent.includes('longfala')) {
                                         qa.click();
                                         break;
                                     }
                                 }
                             }, 150);
                         }, 100);
                     }
                 };
             }
         };
         
         questionWrapper.appendChild(questionDiv);
         questionWrapper.appendChild(shareBtn);
         questionWrapper.appendChild(deleteBtn);
         itemDiv.appendChild(questionWrapper);
         itemDiv.appendChild(extendBtnContainer);
         itemDiv.appendChild(answerDiv);
         historyList.appendChild(itemDiv);
         });
         historyModal.style.display = 'flex';
         };
         
         closeHistoryBtn.onclick = () => { historyModal.style.display = 'none'; };
         
         // Download history backup
         document.getElementById('downloadHistoryBtn').onclick = () => {
		 const t = translations[currentLang];
             if (history.length === 0) {            
				 showAlert(t.noAnswersToDownload, '‚ö†Ô∏è');
                 return;
             }
             
             let textContent = 'BAEBOL KWESTIN - Ol Kwestin mo Ansa Blong Mi\n';
             textContent += '='.repeat(50) + '\n\n';
             
             history.forEach((item, index) => {
                 textContent += `Kwestin ${index + 1}: ${item.q}\n`;
                 textContent += `Taem: ${item.date}\n`;
                 textContent += '-'.repeat(50) + '\n';
                 textContent += item.rawAnswer || item.a || '';
                 textContent += '\n\n' + '='.repeat(50) + '\n\n';
             });
             
             const blob = new Blob([textContent], { type: 'text/plain' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `Baebol-Kwestin-${new Date().toISOString().split('T')[0]}.txt`;
             a.click();
             URL.revokeObjectURL(url);
             
             showAlert(t.answersSaved, '‚úì');
         };
         
         // Clear all history
         document.getElementById('clearHistoryBtn').onclick = async () => {
			 const t = translations[currentLang];
             if (history.length === 0) {         
				 showAlert(t.noAnswersToDelete, '‚ö†Ô∏è');
                 return;
             }
             
             if (await showConfirm(t.confirmDeleteAll)) {
                 localStorage.removeItem('bibleHistory');
                 history = [];
                 updateHistoryBtn();
                 showWelcome();
                 historyModal.style.display = 'none';
                 showAlert(t.allAnswersDeleted, '‚úì');
             }
         };
         
         historyModal.onclick = e => { if (e.target === historyModal) historyModal.style.display = 'none'; };
		 
		// Initialize UI with saved language
		updateUI();

		// Language FAB click handler
		langFab.onclick = () => {
			langModal.style.display = 'flex';
		};

		// Language option click handlers
		document.querySelectorAll('.lang-option').forEach(opt => {
			opt.onclick = () => {
				currentLang = opt.getAttribute('data-lang');
				localStorage.setItem('language', currentLang);
				updateUI();
				langModal.style.display = 'none';
			};
		});

		// Close modal on outside click
		langModal.onclick = (e) => {
			if (e.target === langModal) langModal.style.display = 'none';
		};		 

		// === SHARE ANSWER BUTTON (Main View) ===
		document.getElementById('shareAnswerBtn').onclick = async () => {
		  if (!currentQuestion || !currentAnswer) return;
		  const plainAnswer = formatAnswerForShare(currentAnswer);
		  const appLink = window.location.origin + window.location.pathname;
		  const shareText = `Tajem link ia ${appLink} blong instolem app we i mekem ansa ia.\n\n---\nKWESTIN: ${currentQuestion}\n\nANSA:\n${plainAnswer}\n\n--- Baebol Kwestin App ---`;
		  try {
			await navigator.clipboard.writeText(shareText);
			if (navigator.share) {
			  await navigator.share({ title: `Baebol Kwestin - ${currentQuestion}`, text: shareText });
			} else {
			  showAlert('Ansa i kopi finis! Yu save pestem long narafala ples.');
			}
		  } catch (err) {
			if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
			  showAlert('Ansa i kopi finis! Yu save pestem long narafala ples.');
			}
		  }
		};
       
         // === DELETE ANSWER BUTTON (Main View) ===
         document.getElementById('deleteAnswerBtn').onclick = async () => {
				 const t = translations[currentLang];
				 if (await showConfirm(t.confirmDeleteAnswer)) {
                 answerDiv.style.display = 'none';
                 answerHeader.style.display = 'none';
                 answerContent.innerHTML = '';
                 currentQuestion = '';
                 currentAnswer = '';
                 welcomeVerse.style.display = 'block';
             }
         };

         explainMoreBtn.onclick = async () => { 
             const t = translations[currentLang];
			 askBtn.textContent = t.waitMessage;
			 explainMoreBtn.textContent = t.waitMessage;
             explainMoreBtn.disabled = true;

             explainMoreBtn.classList.add('button-loading');
             errorMessage.style.display = 'none';
             
             const result = await getAnswer(currentQuestion, true);
             
             if (result.source === 'fallback') {
                 const t = translations[currentLang];
				 errorMessage.textContent = t.noInternet;
                 errorMessage.style.display = 'block';
                 answerContent.innerHTML = marked.parse(currentAnswer);
             } else {
                 answerContent.innerHTML = marked.parse(result.text);
                 currentAnswer = result.text;
                 const verseMatch = result.text.match(/\*\*([A-Za-z0-9 ]+:\d+)\*\* \*"([^"]+)"\*/);
                 const verse = verseMatch ? { ref: verseMatch[1], text: verseMatch[2] } : null;
                 const longQuestion = currentQuestion + ' -longfala';
                 saveAnswer(longQuestion, result.text, verse);
                 explainMoreBtn.style.display = 'none';
             }			
             askBtn.disabled = false; 
			 askBtn.textContent = t.askBtn;
             explainMoreBtn.disabled = false;
             explainMoreBtn.textContent = t.explainMoreBtn;
             explainMoreBtn.classList.remove('button-loading');
         };
         
         questionInput.addEventListener('input', () => {
             clearBtn.style.display = questionInput.value ? 'flex' : 'none';
         });
         questionInput.addEventListener('focus', () => {
             questionInput.setAttribute('data-placeholder', questionInput.placeholder);
             questionInput.placeholder = '';
         });
         questionInput.addEventListener('blur', () => {
             const saved = questionInput.getAttribute('data-placeholder');
             if (saved) questionInput.placeholder = saved;
         });
         clearBtn.onclick = () => {
             questionInput.value = '';
             clearBtn.style.display = 'none';
             questionInput.focus();
         };
		 
		// === UPDATE USER INTERFACE ===
		function updateUI() {
			const t = translations[currentLang];
			
			// Update all elements with data-i18n attribute
			document.querySelectorAll('[data-i18n]').forEach(el => {
				const key = el.getAttribute('data-i18n');
				if (t[key]) {
					el.textContent = t[key];
				}
			});
			
			// Update placeholder
			const placeholder = document.getElementById('question');
			if (placeholder) {
				placeholder.placeholder = t.inputPlaceholder;
			}
			
			// Update tooltips
			document.getElementById('shareBtn').title = t.shareTooltip;
			document.getElementById('shareAnswerBtn').title = t.shareTooltip;
			document.getElementById('deleteAnswerBtn').title = t.deleteTooltip;
			document.getElementById('langFab').title = t.languageTooltip;
			document.getElementById('darkFab').title = t.darkModeTooltip;
			
			// Update history button with count
			updateHistoryBtn();
			
			// Update active language in modal
			document.querySelectorAll('.lang-option').forEach(opt => {
				opt.classList.remove('active');
				if (opt.getAttribute('data-lang') === currentLang) {
					opt.classList.add('active');
				}
			});
		}

		// === PWA INSTALL (aligned with TTK style, but keeps engagement check) ===
		let deferredPrompt = null;
		let installBanner = null;  // We'll create or use a div for the banner
		
		// Create banner if not already in HTML (or add <div id="installBanner">...</div> in body)
		function createInstallBanner() {
		  if (installBanner) return;
		  installBanner = document.createElement('div');
		  installBanner.id = 'installBanner';
		  installBanner.style.cssText = 'display: none; background: #1a5276; color: white; padding: 12px; position: fixed; bottom: 0; left: 0; right: 0; text-align: center; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); flex-direction: row; justify-content: center; align-items: center; gap: 15px;';
		  installBanner.innerHTML = `
		    <span>Install Baebol Kwestin as an app for better experience!</span>
		    <button style="background: white; color: #1a5276; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Install</button>
		    <button style="background: transparent; color: white; border: none; font-size: 20px; cursor: pointer; margin-left: auto;" onclick="this.parentElement.style.display='none'">‚úï</button>
		  `;
		  
		  // Wire up the install button click
		  installBanner.querySelector('button').onclick = () => {
		    if (deferredPrompt) {
		      deferredPrompt.prompt();
		      deferredPrompt.userChoice.then((choiceResult) => {
		        console.log('Install outcome:', choiceResult.outcome);
		        deferredPrompt = null;
		        installBanner.style.display = 'none';
		      });
		    }
		    installBanner.style.display = 'none';  // Hide even if no prompt
		  };
		  
		  document.body.appendChild(installBanner);
		}
		
		let hasEngaged = false;
		const engage = () => {
		  hasEngaged = true;
		  document.removeEventListener('click', engage);
		  document.removeEventListener('touchstart', engage);
		  document.removeEventListener('keydown', engage);
		  if (deferredPrompt) showInstallUI();
		};
		document.addEventListener('click', engage);
		document.addEventListener('touchstart', engage);
		document.addEventListener('keydown', engage);
		
		window.addEventListener('beforeinstallprompt', (e) => {
		  console.log('‚úÖ beforeinstallprompt fired');
		  e.preventDefault();
		  deferredPrompt = e;
		  if (hasEngaged) showInstallUI();
		  else setTimeout(showInstallUI, 2000);  // Slight delay if not engaged yet
		});
		
		function showInstallUI() {
		  createInstallBanner();
		  installBanner.style.display = 'flex';
		}
		
		window.addEventListener('appinstalled', () => {
		  console.log('‚úÖ App installed!');
		  deferredPrompt = null;
		  if (installBanner) installBanner.style.display = 'none';
		});
		
		// Fallback: force show after 10s if prompt arrived but not shown
		setTimeout(() => {
		  if (deferredPrompt && !hasEngaged) showInstallUI();
		}, 10000);
		
		// iOS handling (keep yours ‚Äì it's good)
		const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
		if (isIOS && !('standalone' in navigator && navigator.standalone)) {
		  setTimeout(() => {
		    const iosDiv = document.createElement('div');
		    iosDiv.id = 'iosInstall';
		    iosDiv.style.cssText = 'background: #007aff; color: white; padding: 12px; position: fixed; bottom: 0; left: 0; right: 0; text-align: center; z-index: 9999;';
		    iosDiv.innerHTML = 'Tap <strong>Share</strong> ‚Üí <strong>Add to Home Screen</strong> to install';
		    document.body.appendChild(iosDiv);
		  }, 3000);
		}
		
		// Service Worker (keep if you have sw.js, or remove if not needed yet)
		if ('serviceWorker' in navigator) {
		  window.addEventListener('load', () => {
		    navigator.serviceWorker.register('/AI-Bible-Questions-app/sw.js')
		      .then(reg => console.log('Service Worker registered:', reg.scope))
		      .catch(err => console.error('Service Worker failed:', err));
		  });
		}
         
         // === INIT ===
         updateHistoryBtn();
         showWelcome();
     });
      </script>
   </body>
</html>
