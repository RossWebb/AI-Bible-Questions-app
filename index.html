<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baebol Kwestin</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="/icon-192.png" type="image/png">
    <meta name="theme-color" content="#1a5276">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Baebol">
    <style>
        :root{--bg:#f8fbff;--card:#fff;--text:#2c3e50;--primary:#1a5276;--accent:#3498db;--border:#d6eaf8;--shadow:rgba(0,0,0,0.1);--danger:#e74c3c}
        .dark-mode{--bg:#1a1a1a;--card:#2d2d2d;--text:#f0f0f0;--primary:#64B5F6;--accent:#4FC3F7;--border:#444;--shadow:rgba(0,0,0,0.3)}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Georgia,serif;background:var(--bg);color:var(--text);padding:12px;max-width:800px;margin:auto;display:flex;flex-direction:column;min-height:100vh}
        .header{position:relative;text-align:center;padding:16px 56px 4px}
        h1{color:var(--primary);font-size:1.8em;margin:0;line-height:1.2}
        .fab{
            position:absolute;top:16px;width:48px;height:48px;border-radius:50%;
            background:var(--card);border:1px solid var(--border);box-shadow:0 3px 8px var(--shadow);
            display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;
        }
        .fab svg{width:28px;height:28px;fill:var(--primary)}
        #shareFab{left:8px}#darkFab{right:8px}
        .subtitle{text-align:center;font-style:italic;color:#5d6d7e;margin:2px 0 16px;font-size:1em}
        .card{background:var(--card);padding:20px;border-radius:16px;box-shadow:0 6px 20px var(--shadow);border:1px solid var(--border);margin-bottom:16px}
        label{display:block;font-weight:bold;color:var(--primary);margin-bottom:8px}
        .input-wrapper{position:relative}
        textarea{width:100%;padding:12px 36px 12px 12px;border:1px solid #aed6f1;border-radius:10px;font-size:16px;min-height:90px;resize:vertical}
        .clear-circle{
            position:absolute;top:6px;right:6px;background:var(--danger);color:white;border:none;
            width:20px;height:20px;border-radius:50%;font-size:13px;font-weight:bold;cursor:pointer;
            display:none;align-items:center;justify-content:center;line-height:1;
        }
        .btn-row{display:flex;gap:10px;margin-top:8px}
        button{flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
        #askBtn{background:#2980b9;color:white}#randomBtn{background:#9b59b6;color:white}
        #randomQuestions{margin-top:12px;display:none}
        .random-q-btn{
            display:block;width:100%;margin:8px 0;background:var(--accent);color:white;
            padding:14px;border-radius:12px;cursor:pointer;font-weight:500;text-align:center;
            font-size:15px;line-height:1.4;
        }
        .random-q-btn:hover{background:#2980b9}
        #answer{background:var(--card);padding:18px;border-radius:12px;border-left:5px solid var(--accent);display:none;max-height:60vh;overflow-y:auto}
        #answerHeader{display:none;justify-content:flex-end;margin-bottom:8px}
        #explainMoreBtn{background:var(--accent);color:white;padding:6px 12px;border-radius:6px;font-size:13px}
        #answerContent{line-height:1.8;font-size:15px}
        #answerContent ul, #answerContent ol { padding-left: 1.5em; margin: 0.5em 0; }
        #answerContent li { margin-bottom: 0.3em; }
        #welcomeVerse{text-align:center;background:var(--card);padding:18px;border-radius:12px;display:block}
        #welcomeVerse strong{display:block;color:var(--primary);margin-bottom:.4rem}
        #welcomeVerse em{display:block;margin:0 0 1.2rem;padding-left:1.2rem;position:relative}
        #welcomeVerse em::before{content:'"';color:var(--accent);left:0;position:absolute}
        #welcomeVerse em::after{content:'"';color:var(--accent)}
        #historyBtn{margin-top:12px;text-align:center;display:none}
        #historyBtn button{background:#27ae60;color:white;padding:8px 16px;border-radius:8px;font-weight:bold}
        #historyModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center}
        #historyModal > div{
            background:var(--card);padding:20px;border-radius:16px;max-width:90%;max-height:80%;
            overflow-y:auto;box-shadow:0 10px 30px var(--shadow);position:relative;
        }
        #closeHistoryBtn{
            position:sticky;top:8px;right:8px;background:var(--danger);color:white;border:none;
            width:32px;height:32px;border-radius:50%;font-size:16px;cursor:pointer;
            display:flex;align-items:center;justify-content:center;float:right;margin-bottom:8px;z-index:999;
        }
        .footer{
            margin-top:auto;text-align:center;color:#95a5a6;font-size:.85em;
            padding:12px;background:var(--card);border-top:1px solid var(--border);
        }
        #debug{font-size:12px;color:#7f8c8d;text-align:right;margin-top:4px}
        /* PWA Install Button */
        #installBtn, #iosInstall {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1em;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
            border: none;
            cursor: pointer;
            text-align: center;
            max-width: 90%;
        }
        #installBtn {
            background: #e74c3c;
            color: white;
            animation: flash 1.5s infinite;
        }
        #iosInstall {
            background: #1a5276;
            color: white;
        }
        @keyframes flash {
            0%, 100% { background: #e74c3c; }
            50% { background: #c0392b; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="header">
        <button id="shareFab" class="fab" title="Share">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
        </button>
        <button id="darkFab" class="fab" title="Dark Mode">
            <svg id="moon" viewBox="0 0 24 24"><path d="M12 1c-6.07 0-11 5.43-11 11s4.93 11 11 11 11-4.93 11-11-4.93-11-11-11zm-0 18c-4.14 0-7.5-3.36-7.5-7.5 0-2.6 1.32-4.88 3.33-6.23.61-.41 1.39.25.94.94-.68 1.05-1.07 2.29-1.07 3.62 0 3.59 2.91 6.5 6.5 6.5 1.33 0 2.57-.39 3.62-1.07.69-.45 1.35.33.94.94-1.35 2.01-3.63 3.33-6.76 3.33z"/></svg>
            <svg id="sun" viewBox="0 0 24 24" style="display:none"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1H2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zm18 0h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zm-9-9h2c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1zm0 18h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2c0 .55.45 1 1 1z"/></svg>
        </button>
        <h1>Baebol Kwestin</h1>
    </div>
    <p class="subtitle">Askem eni kwestin long Baebol</p>
    <div class="card">
        <form id="queryForm">
            <label>Raetem kwestin blong yu:</label>
            <div class="input-wrapper">
                <textarea id="question" placeholder="e.g., From wanem Jisas i mas ded long kros?"></textarea>
                <button type="button" id="clearBtn" class="clear-circle">x</button>
            </div>
            <div class="btn-row">
                <button type="submit" id="askBtn">Askem Baebol</button>
                <button type="button" id="randomBtn">Givim Kwestin</button>
            </div>
            <div id="historyBtn"><button type="button" id="showHistoryBtn">Ol kwestin (0)</button></div>
            <div id="randomQuestions"></div>
            <div id="debug"></div>
        </form>
    </div>
    <div id="answer">
        <div id="answerHeader">
            <button type="button" id="explainMoreBtn">Mekem ansa i longfala...</button>
        </div>
        <div id="answerContent"></div>
    </div>
    <div id="welcomeVerse"></div>
    <div id="historyModal">
        <div>
            <button id="closeHistoryBtn">x</button>
            <h3 style="margin:0 0 12px;color:var(--primary);text-align:center">Ol Kwestin We Yu Askem Finis</h3>
            <div id="historyList"></div>
        </div>
    </div>
    <footer class="footer">
        Ross Webb i mekem app ia (2.0) — 12 Nov 2025
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === KEYS ===
            const GEMINI_KEY = atob("QUl6YVN5RDZXbzB1cHFmd0NiaUEwRTZpQ0tIclJ2Mm5EYTZfSTVN");
            const OR_KEY = atob("c2stb3ItdjEtMDRkYTAwZjc5YzIzZTQ2MTgzMDcxYzRhNDYwMmVmZWY0ZmMxOTdiZWEwZTdkMTIwZTVkNWE2OWQwNjNhNGQwYQ==");
            marked.setOptions({ gfm: true, breaks: false, sanitize: false, headerIds: false });

            // === ELEMENTS ===
            const darkFab = document.getElementById('darkFab');
            const moon = document.getElementById('moon');
            const sun = document.getElementById('sun');
            const form = document.getElementById('queryForm');
            const questionInput = document.getElementById('question');
            const askBtn = document.getElementById('askBtn');
            const randomBtn = document.getElementById('randomBtn');
            const randomDiv = document.getElementById('randomQuestions');
            const answerDiv = document.getElementById('answer');
            const answerHeader = document.getElementById('answerHeader');
            const answerContent = document.getElementById('answerContent');
            const explainMoreBtn = document.getElementById('explainMoreBtn');
            const clearBtn = document.getElementById('clearBtn');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            const welcomeVerse = document.getElementById('welcomeVerse');
            const historyModal = document.getElementById('historyModal');
            const historyList = document.getElementById('historyList');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            const debugDiv = document.getElementById('debug');
            let currentQuestion = '';
            let isAutoSubmit = false;

            // === DARK MODE ===
            darkFab.onclick = () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                moon.style.display = isDark ? 'none' : 'block';
                sun.style.display = isDark ? 'block' : 'none';
                localStorage.setItem('darkMode', isDark);
            };
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                moon.style.display = 'none';
                sun.style.display = 'block';
            }

            // === SYSTEM PROMPT ===
            const systemPrompt = `You are a kind Bible teacher in Vanuatu.
Answer in SIMPLE, ACTIVE English that a 13-year-old can read and understand.
Answers follow solid REFORMED theology.
Do NOT contradict these truths:
- God created everything and is sovereign.
- Every person sins and needs forgiveness.
- Jesus, God’s Son, died on the cross to pay for sin.
- He rose again to give new life.
- Salvation is by faith in Jesus alone, not works.
- The Holy Spirit helps us obey and love others.
- The Bible is God’s true Word.
- Jesus will return to judge; believers go to heaven, unbelievers to hell (as the Bible teaches).
**FORMAT EXACTLY LIKE THIS:**
Do *NOT* start with an introductory greeting
## Main Idea
### Step 1: Do This
- bullet points
- keep short
### Step 2: Remember This
Followed by at least 3 supporting verses, each on a new line, from NIrV version of the Bible styled like this:
**John 3:16** *"For God loved the world so much that he gave his only Son, so that everyone who believes in him may not die but have eternal life."*
End with one short sentence of hope or encouragement.
Keep under 350 words. Cite 3+ verses from the NIrV version of the Bible. Be warm, clear, and kind.`;

            // === FETCH WITH TIMEOUT ===
            async function fetchWithTimeout(url, options = {}, timeout = 15000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal });
                    clearTimeout(id);
                    return res;
                } catch (e) {
                    clearTimeout(id);
                    console.error("Fetch failed:", e.message);
                    throw e;
                }
            }

            // === ANSWER GENERATOR ===
            async function getAnswer(q, isExplainMore = false) {
                const fullQ = isExplainMore
                    ? q + "\n\nGive a FULL, DETAILED answer suitable for Bible study. Up to 1200 words. Cite 5+ verses from NIrv version of the Bible."
                    : q;
                // TIER 1: GEMINI 2.5 FLASH
                try {
                    const res = await fetchWithTimeout(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemPrompt + "\n\nQuestion: " + fullQ }] }],
                            generationConfig: { maxOutputTokens: 2048, temperature: 0.7 },
                            safetySettings: [
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }
                            ]
                        })
                    }, 15000);
                    if (res.ok) {
                        const data = await res.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text && text.length > 150) {
                            debugDiv.textContent = "Gemini 2.5 Flash";
                            return { text, source: 'Gemini' };
                        }
                    }
                } catch (e) {}
                // TIER 2: MISTRAL MIXTRAL
                try {
                    const res = await fetchWithTimeout('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OR_KEY}`
                        },
                        body: JSON.stringify({
                            model: "mistralai/mixtral-8x22b-instruct:free",
                            messages: [
                                { role: "system", content: systemPrompt },
                                { role: "user", content: fullQ }
                            ],
                            max_tokens: 2000,
                            temperature: 0.7
                        })
                    }, 15000);
                    if (res.ok) {
                        const data = await res.json();
                        const text = data.choices?.[0]?.message?.content;
                        if (text && text.length > 150) {
                            debugDiv.textContent = "OpenRouter (Mixtral 8x22B)";
                            return { text, source: 'OpenRouter' };
                        }
                    }
                } catch (e) {}
                // TIER 3: FALLBACK
                debugDiv.textContent = "Fallback (no connection)";
                return {
                    text: `## Jesus is Stronger
### Step 1: Know This
- Spirits are real, but Jesus is Lord over all.
- The Bible says do not talk to the dead.
- Trust God, not kastom power.
### Step 2: Remember This
**Deuteronomy 18:10-12** *"Do not practice magic or witchcraft... The Lord hates people who do these things."*
**Isaiah 8:19** *"There are people who get messages from those who have died. But these people only whisper words that are barely heard. Suppose someone tells you to ask for advice from these people. Shouldn’t you ask for advice from your God instead? Why should you get advice from dead people to help those who are alive?"*
**Colossians 2:15** *"Christ freed himself from the power of the spiritual rulers..."*
Jesus wins. You are safe in Him.`,
                    source: 'fallback'
                };
            }

            // === SUBMIT ===
            const handleSubmit = async (q) => {
                if (!q) return;
                currentQuestion = q;
                askBtn.disabled = true; askBtn.textContent = 'Please wait...';
                answerDiv.style.display = 'none'; answerHeader.style.display = 'none';
                answerContent.innerHTML = ''; welcomeVerse.style.display = 'none';
                debugDiv.textContent = 'Loading...';
                const result = await getAnswer(q);
                answerContent.innerHTML = marked.parse(result.text);
                answerHeader.style.display = 'flex';
                answerDiv.style.display = 'block';
                const verseMatch = result.text.match(/\*\*([A-Za-z0-9 ]+:\d+)\*\* \*"([^"]+)"\*/);
                const verse = verseMatch ? { ref: verseMatch[1], text: verseMatch[2] } : null;
                saveAnswer(q, answerContent.innerHTML, verse);
                askBtn.disabled = false; askBtn.textContent = 'Askem Baebol';
                isAutoSubmit = false;
            };
            form.addEventListener('submit', e => {
                e.preventDefault();
                if (isAutoSubmit) return;
                const q = questionInput.value.trim();
                if (!q) return;
                handleSubmit(q);
            });

            // === RANDOM QUESTIONS ===
            const ANIMISM_SEED = [
"Why does the Bible say not to talk to dead people?",
            "Can spirits in the bush really hurt me?",
            "Is it wrong to use kastom medicine with Bible prayers?",
            "What does the Bible say about people who see spirits?",
            "Can a Christian go to a kastom dance?",
            "What does the Bible say about nakaimas?",
            "Is it okay to burn a house where someone died?",
            "Can a Christian use love magic?",
            "What does the Bible say about dreams from spirits?",
            "Is it wrong to pay bride price with kastom money?",
            "Can spirits follow you if you move villages?",
            "What does the Bible say about tabu places?",
            "Is it okay to eat food offered to spirits?",
            "Can a Christian wear kastom clothes to church?",
            "What does the Bible say about people who do poison?",
            "Is it wrong to go to a kastom healer?",
            "Can Christians dance in kastom ceremonies?",
            "What does the Bible say about ancestors watching us?",
            "Is it okay to keep kastom carvings in the house?",
"Should I burn my old kastom things?",
            "Can a Christian marry someone who follows kastom?"
            ];
            const AI_QUESTIONS = [
                "What does it mean to be born again?",
                "How can I know God forgives me?",
                "Why did Jesus have to die on the cross?",
                "What is the Holy Spirit and what does He do?"
            ];
            const showQuestionButtons = (qs) => {
                randomDiv.innerHTML = '';
                qs.forEach(q => {
                    const b = document.createElement('button');
                    b.className = 'random-q-btn';
                    b.textContent = q;
                    b.onclick = () => {
                        questionInput.value = q;
                        questionInput.dispatchEvent(new Event('input'));
                        randomDiv.style.display = 'none';
                        isAutoSubmit = true;
                        handleSubmit(q);
                    };
                    randomDiv.appendChild(b);
                });
                randomDiv.style.display = 'block';
            };
            randomBtn.onclick = () => {
                const animism = ANIMISM_SEED[Math.floor(Math.random() * ANIMISM_SEED.length)];
                const shuffledAI = AI_QUESTIONS.sort(() => 0.5 - Math.random()).slice(0, 4);
                showQuestionButtons([animism, ...shuffledAI]);
            };

            // === HISTORY & WELCOME ===
            let history = [];
            try {
                const raw = localStorage.getItem('bibleHistory');
                if (raw) history = JSON.parse(raw).filter(i => i && i.q && i.a);
            } catch (e) {}
            const saveAnswer = (q, a, verse) => {
                const newItem = { q, a, date: new Date().toLocaleString('en-GB') };
                if (verse) newItem.verse = verse;
                history = [newItem, ...history].slice(0, 50);
                try { localStorage.setItem('bibleHistory', JSON.stringify(history)); } catch(e) {}
                updateHistoryBtn();
                showWelcome();
            };
            const updateHistoryBtn = () => {
                const cnt = history.length;
                showHistoryBtn.textContent = `Ol kwestin we yu askem finis (${cnt})`;
                document.getElementById('historyBtn').style.display = cnt ? 'block' : 'none';
            };
            const showWelcome = () => {
                welcomeVerse.style.display = 'none';
                if (history.length > 0 && history[0].verse) {
                    const v = history[0].verse;
                    welcomeVerse.innerHTML = `<strong>${v.ref}</strong><br><em>${v.text}</em>`;
                } else {
                    const v = { ref: "John 3:16", text: "For God loved the world so much that he gave his one and only Son, so that everyone who believes in him may not die but have eternal life." };
                    welcomeVerse.innerHTML = `<strong>${v.ref}</strong><br><em>${v.text}</em>`;
                }
                welcomeVerse.style.display = 'block';
            };
            showHistoryBtn.onclick = () => {
                historyList.innerHTML = '';
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.style = 'border-bottom:1px solid var(--border);padding:12px 0;cursor:pointer;';
                    div.innerHTML = `<p style="margin:0;font-weight:bold;color:var(--primary)">${item.q}</p>
                                     <p style="margin:4px 0 8px;font-size:.9em;color:#7f8c8d">${item.date}</p>
                                     <div style="font-size:15px;line-height:1.7">${item.a}</div>`;
                    div.onclick = () => {
                        QUESTIONInput.value = item.q;
                        questionInput.dispatchEvent(new Event('input'));
                        answerContent.innerHTML = item.a;
                        answerHeader.style.display = 'flex';
                        answerDiv.style.display = 'block';
                        welcomeVerse.style.display = 'none';
                        historyModal.style.display = 'none';
                    };
                    historyList.appendChild(div);
                });
                historyModal.style.display = 'flex';
            };
            closeHistoryBtn.onclick = () => { historyModal.style.display = 'none'; };
            historyModal.onclick = e => { if (e.target === historyModal) historyModal.style.display = 'none'; };
            explainMoreBtn.onclick = async () => {
                askBtn.disabled = true; askBtn.textContent = 'Please wait...';
                const result = await getAnswer(currentQuestion, true);
                answerContent.innerHTML = marked.parse(result.text);
                const verseMatch = result.text.match(/\*\*([A-Za-z0-9 ]+:\d+)\*\* \*"([^"]+)"\*/);
                const verse = verseMatch ? { ref: verseMatch[1], text: verseMatch[2] } : null;
                saveAnswer(currentQuestion, answerContent.innerHTML, verse);
                askBtn.disabled = false; askBtn.textContent = 'Askem Baebol';
            };
            questionInput.addEventListener('input', () => {
                clearBtn.style.display = questionInput.value ? 'flex' : 'none';
            });
            clearBtn.onclick = () => {
                questionInput.value = '';
                clearBtn.style.display = 'none';
                questionInput.focus();
            };

// === PWA INSTALL — FIXED ===
let deferredPrompt = null;
let installBtn = null;
let hasEngaged = false;

// Strong engagement
const engage = () => {
    hasEngaged = true;
    document.removeEventListener('click', engage);
    document.removeEventListener('touchstart', engage);
    document.removeEventListener('keydown', engage);
    if (deferredPrompt) showInstallButton();
};
document.addEventListener('click', engage);
document.addEventListener('touchstart', engage);
document.addEventListener('keydown', engage);

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('PWA: beforeinstallprompt fired');
    e.preventDefault();
    deferredPrompt = e;

    // Auto-show install button after 1.5 s (no user tap required)
    setTimeout(showInstallButton, 1500);
});

function showInstallButton() {
    if (installBtn) return;
    installBtn = document.createElement('button');
    installBtn.id = 'installBtn';
    installBtn.textContent = 'Instolem Baebol Kwestin';
    installBtn.onclick = () => {
        installBtn.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
            deferredPrompt = null;
            installBtn = null;
        });
    };
    document.body.appendChild(installBtn);
}

// Force after 10s
setTimeout(() => {
    if (deferredPrompt && !installBtn) showInstallButton();
}, 10000);

// iOS
const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
if (isIOS && !window.navigator.standalone) {
    const iosDiv = document.createElement('div');
    iosDiv.id = 'iosInstall';
    iosDiv.innerHTML = 'Tap Share → Add to Home Screen';
    document.body.appendChild(iosDiv);
}

// SW with correct path
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
        .then(r => console.log('SW registered:', r.scope))
        .catch(e => console.error('SW failed:', e));
}

            // === INIT ===
            updateHistoryBtn();
            showWelcome();
        }); // END DOMContentLoaded
    </script>
</body>
</html>

